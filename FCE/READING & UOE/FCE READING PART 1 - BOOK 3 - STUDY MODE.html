<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCE Reading Part 1 - Set 3 (Book 3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #f0fdf4; }
        .gap-slot { display: inline-block; min-width: 45px; border-bottom: 2px solid #cbd5e1; text-align: center; font-weight: bold; color: #64748b; padding: 0 6px; transition: all 0.3s; cursor: default; }
        .filled-text { display: inline-block; padding: 0 6px; font-weight: 700; border-radius: 6px; transition: all 0.3s ease-in-out; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .filled-correct { color: #15803d; background-color: #dcfce7; border-bottom: 2px solid #16a34a; }
        .filled-wrong { color: #b91c1c; background-color: #fee2e2; border-bottom: 2px solid #dc2626; text-decoration: line-through; }
        .option-btn { transition: all 0.2s; }
        .option-btn:disabled { cursor: not-allowed; }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .penalty-bar { height: 4px; background-color: #ef4444; width: 100%; animation: shrink 10s linear forwards; }
        @keyframes shrink { from { width: 100%; } to { width: 0%; } }
        .global-lock-overlay { position: absolute; inset: 0; background: rgba(255, 255, 255, 0.6); z-index: 10; display: flex; align-items: center; justify-content: center; border-radius: 1rem; backdrop-filter: blur(1px); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="fixed inset-0 z-50 bg-white flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white shadow-2xl rounded-2xl p-8 border-t-8 border-green-600 text-center">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">FCE Reading Part 1</h1>
            <p class="text-slate-500 mb-2 font-semibold text-green-600">SET 3 (Book 3)</p>
            <div class="inline-block bg-orange-100 text-orange-800 text-xs font-bold px-3 py-1 rounded-full mb-6 border border-orange-200 uppercase tracking-wide">
                Mastery Study Mode
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-left text-sm font-semibold text-slate-700 mb-1">Your Name</label>
                    <input type="text" id="username-input" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition" placeholder="Enter your full name...">
                </div>
                <button onclick="startApp()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">
                    Start Practice
                </button>
            </div>
            
            <!-- Mastery Rules -->
            <div class="mt-6 text-sm text-slate-500 bg-slate-50 p-5 rounded-xl text-left border border-slate-200 shadow-inner">
                <p class="font-bold mb-3 text-slate-700 flex items-center uppercase tracking-wider text-xs border-b pb-2 border-slate-200">
                    <svg class="w-4 h-4 mr-2 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                    Mastery Rules
                </p>
                <ul class="space-y-3 text-xs text-slate-600">
                    <li class="flex items-start">
                        <span class="text-green-600 font-bold mr-2">✓ 1st Try Correct:</span>
                        <span>Full points (100%).</span>
                    </li>
                    <li class="flex items-start">
                        <span class="text-orange-500 font-bold mr-2">⚠ 1st Try Wrong:</span>
                        <span>
                            <strong>10s Penalty Wait</strong> + Global Lock.
                            <br>Score reduced to 50%.
                        </span>
                    </li>
                    <li class="flex items-start">
                        <span class="text-red-500 font-bold mr-2">✕ 2nd Try Wrong:</span>
                        <span>0 points. Answer revealed.</span>
                    </li>
                    <li class="flex items-start border-t border-slate-200 pt-2 mt-2">
                        <span class="text-blue-600 font-bold mr-2">★ Target:</span>
                        <span>You need <strong>85% score</strong> to pass.</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="hidden fixed inset-0 z-50 bg-slate-50 overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="max-w-2xl w-full bg-white shadow-2xl rounded-2xl p-8 relative">
                <!-- Status Bar -->
                <div id="result-header-bar" class="absolute top-0 left-0 w-full h-3 rounded-t-2xl bg-gray-300"></div>
                
                <h2 class="text-3xl font-bold text-center mb-2 text-slate-800">Study Mode Results</h2>
                
                <!-- Sending Status -->
                <div id="saving-status" class="text-center text-xs font-semibold text-slate-400 mb-6 flex items-center justify-center p-2 bg-slate-50 rounded-lg">
                    Waiting to submit...
                </div>

                <p id="result-message" class="text-center mb-8 font-semibold text-lg text-slate-500">---</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100">
                        <p class="text-xs text-blue-500 font-bold uppercase tracking-wide">Candidate</p>
                        <p class="text-xl font-bold text-slate-800 truncate" id="result-name">---</p>
                    </div>
                    <div id="score-card" class="bg-slate-50 p-5 rounded-2xl border border-slate-200">
                        <p class="text-xs text-slate-500 font-bold uppercase tracking-wide">Mastery Score</p>
                        <div class="flex items-baseline">
                            <span id="result-score" class="text-4xl font-black text-slate-700">0</span>
                            <span class="text-lg text-slate-500 font-medium ml-1">/32</span>
                            <span id="result-percentage" class="ml-auto text-lg font-bold px-2 py-1 rounded bg-white border">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Pass/Fail Action Area -->
                <div id="action-area" class="mb-8">
                    <!-- Buttons will be injected here -->
                </div>

                <div class="bg-white p-6 rounded-xl border border-slate-200 mb-8 shadow-sm">
                    <h3 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Performance Stats
                    </h3>
                    <div class="flex justify-between items-center mb-2 text-sm">
                        <span class="text-slate-500">Duration:</span>
                        <span id="result-duration" class="text-slate-800 font-bold">---</span>
                    </div>
                    <div class="mt-4 space-y-3" id="result-details">
                        <!-- Detailed breakdown -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden flex-1 flex flex-col h-full bg-slate-100">
        <!-- Header -->
        <header class="bg-white shadow-sm z-20 border-b border-slate-200 h-16 flex items-center justify-between px-4 md:px-6">
            <div class="flex items-center space-x-4">
                <div class="bg-green-50 text-green-700 px-3 py-1.5 rounded-lg text-sm font-bold flex items-center border border-green-200 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="timer-display" class="tabular-nums">00:00:00</span>
                </div>
                <h2 id="part-title" class="hidden md:block text-lg font-bold text-slate-700 truncate max-w-xs">Part 1</h2>
            </div>
            <div class="flex items-center space-x-2 md:space-x-4">
                <div class="text-sm font-medium text-slate-500 mr-2 flex flex-col items-end md:items-center md:flex-row">
                    <span class="text-xs uppercase font-bold text-slate-400 md:mr-2">Progress</span>
                    <span id="progress-text" class="text-slate-800 font-black text-xl">1/4</span>
                </div>
                <div class="flex space-x-2">
                    <button onclick="prevTest()" id="btn-prev" class="p-2 rounded-full bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 disabled:opacity-30 disabled:cursor-not-allowed transition shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <button onclick="nextTest()" id="btn-next" class="p-2 rounded-full bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 disabled:opacity-30 disabled:cursor-not-allowed transition shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>
                <button onclick="finishTest()" id="btn-finish" class="hidden ml-2 bg-green-600 hover:bg-green-700 text-white text-sm font-bold px-5 py-2.5 rounded-lg shadow-md hover:shadow-lg transition transform active:scale-95 flex items-center">
                    <span>FINISH</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <main class="flex-1 overflow-hidden flex flex-col md:flex-row">
            
            <!-- Left: Reading Text -->
            <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 border-r border-slate-200">
                <div class="max-w-3xl mx-auto bg-white p-8 md:p-10 rounded-2xl shadow-sm border border-slate-100 leading-loose text-lg text-slate-700" id="reading-text">
                    <!-- Text content rendered here -->
                </div>
            </div>

            <!-- Right: Questions -->
            <div class="h-[50%] md:h-auto md:w-[480px] lg:w-[550px] flex flex-col bg-white shadow-[-4px_0_20px_-5px_rgba(0,0,0,0.1)] z-10">
                <div class="p-4 bg-white border-b border-slate-100 font-bold text-slate-700 flex justify-between items-center shadow-sm z-10">
                    <span class="flex items-center text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        QUESTIONS
                    </span>
                    <span class="text-[10px] font-bold bg-orange-100 text-orange-700 px-2 py-1 rounded border border-orange-200 uppercase tracking-wider">Study Mode</span>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-50/50" id="questions-container">
                    <!-- Questions rendered here -->
                </div>
            </div>
        </main>
    </div>

    <!-- FIREBASE INTEGRATION (Module) -->
    <script type="module">
        // -------------------------------------------------------------
        // ▼▼▼ KHU VỰC CẤU HÌNH (DÁN CONFIG CỦA BẠN VÀO ĐÂY) ▼▼▼
        // -------------------------------------------------------------
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
             // ⚠️ DÁN CONFIG CỦA BẠN VÀO GIỮA 2 DẤU NGOẶC NÀY ⚠️
        };

        // -------------------------------------------------------------
        // ▲▲▲ KẾT THÚC KHU VỰC CẤU HÌNH ▲▲▲
        // -------------------------------------------------------------

        let db;
        let isFirebaseReady = false;

        try {
            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                isFirebaseReady = true;
                console.log("Firebase initialized successfully");
            } else {
                console.warn("Firebase config is missing. Data will not be saved.");
            }
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }

        // Expose function to global scope so main script can call it
        window.saveResultToFirebase = async function(data) {
            const statusEl = document.getElementById('saving-status');
            
            // CLEANED UP: No more orange warning if config missing
            if (!isFirebaseReady) {
                statusEl.innerHTML = '';
                return;
            }

            statusEl.innerHTML = '<span class="animate-pulse text-blue-600 flex items-center justify-center"><svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Saving results to Firebase...</span>';

            try {
                // Save to collection 'exam_results_set3'
                await addDoc(collection(db, "exam_results_set3"), {
                    name: data.name,
                    score: data.score,          
                    percentage: data.percentage, 
                    duration: data.duration,
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent
                });
                
                statusEl.innerHTML = '<span class="text-green-600 font-bold flex items-center justify-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Results Saved to Cloud!</span>';
            } catch (error) {
                console.error("Error adding document: ", error);
                statusEl.innerHTML = '<span class="text-red-500 font-bold">❌ Error saving. Check console.</span>';
            }
        }
    </script>

    <script>
        // DATA SET 3 (Book 3 - Tests 9-12)
        const testsData = [
            {
                id: 1,
                title: "Messages from the Stone Age",
                content: `The incredible pre-historic Chumash paintings in Santa Barbara were lately discovered by a handful of hikers in the 1600s. It wasn't until the 1960s, though, that archeologists really began to (0) <span class="gap-slot filled-correct font-bold text-green-700">take</span> an interest. The paintings, which are located in a cave, are in a (1) <span id="gap-1-1" class="gap-slot">......</span> remote area, which makes them difficult to reach.<br><br>
                For this reason, (2) <span id="gap-1-2" class="gap-slot">......</span> efforts to protect the site have been largely successful. However, a study was recently (3) <span id="gap-1-3" class="gap-slot">......</span> out to assess the impact of visitors on the cave. It found that while most people were respectful, a small number had caused damage. As a result, authorities have decided to (4) <span id="gap-1-4" class="gap-slot">......</span> access to the cave.<br><br>
                Visitors must now book a guided tour in (5) <span id="gap-1-5" class="gap-slot">......</span> . This allows the guides to monitor the group and ensure that no one touches the paintings. The cave is a spiritual site for the Chumash people, so it is important that visitors behave (6) <span id="gap-1-6" class="gap-slot">......</span> . Although the new rules may seem strict, they are necessary to (7) <span id="gap-1-7" class="gap-slot">......</span> this unique heritage for future generations. If you are lucky enough to visit, you will be rewarded with a (8) <span id="gap-1-8" class="gap-slot">......</span> of a fascinating ancient culture.`,
                questions: [
                    {
                        id: 1,
                        options: { A: "far", B: "highly", C: "distinctly", D: "relatively" },
                        correct: "D",
                        explanation: "<strong>Đáp án đúng: D. relatively</strong><br><em>'Relatively remote'</em> nghĩa là 'tương đối hẻo lánh'. Đây là cách diễn đạt phổ biến để so sánh mức độ.<br><strong>Tại sao sai:</strong><br>• A. far: không bổ nghĩa cho tính từ theo cách này (far too remote).<br>• B. highly: thường dùng cho tính từ trừu tượng (highly unlikely).<br><strong>Ghi nhớ:</strong> Collocation: 'relatively small/easy/remote'."
                    },
                    {
                        id: 2,
                        options: { A: "previous", B: "early", C: "former", D: "old" },
                        correct: "A",
                        explanation: "<strong>Đáp án đúng: A. previous</strong><br>Những nỗ lực 'trước đây' (previous efforts).<br><strong>Tại sao sai:</strong><br>• B. early: sớm (giai đoạn đầu).<br>• C. former: cựu (dùng cho người/chức vụ).<br><strong>Ghi nhớ:</strong> Previous attempts/efforts."
                    },
                    {
                        id: 3,
                        options: { A: "made", B: "done", C: "carried", D: "held" },
                        correct: "C",
                        explanation: "<strong>Đáp án đúng: C. carried</strong><br>Cụm động từ <em>'carry out a study/research'</em> (tiến hành nghiên cứu).<br><strong>Tại sao sai:</strong><br>• A. made: sai kết hợp từ.<br>• B. done: done a study (không trang trọng bằng carried out).<br><strong>Ghi nhớ:</strong> Phrasal verb: 'carry out'."
                    },
                    {
                        id: 4,
                        options: { A: "prevent", B: "limit", C: "block", D: "avoid" },
                        correct: "B",
                        explanation: "<strong>Đáp án đúng: B. limit</strong><br>Hạn chế (limit) sự tiếp cận/truy cập.<br><strong>Tại sao sai:</strong><br>• A. prevent: ngăn chặn hoàn toàn.<br>• C. block: chặn đường.<br><strong>Ghi nhớ:</strong> Limit access to."
                    },
                    {
                        id: 5,
                        options: { A: "ahead", B: "time", C: "advance", D: "future" },
                        correct: "C",
                        explanation: "<strong>Đáp án đúng: C. advance</strong><br>Cụm từ cố định <em>'in advance'</em> nghĩa là 'trước'.<br><strong>Tại sao sai:</strong><br>• A. ahead: go ahead.<br>• B. time: in time (kịp giờ).<br><strong>Ghi nhớ:</strong> Idiom: 'book in advance'."
                    },
                    {
                        id: 6,
                        options: { A: "appropriately", B: "correctly", C: "suitably", D: "rightly" },
                        correct: "A",
                        explanation: "<strong>Đáp án đúng: A. appropriately</strong><br>Cư xử một cách 'phù hợp/đúng mực' (behave appropriately) ở chốn linh thiêng.<br><strong>Tại sao sai:</strong><br>• B. correctly: đúng (về kỹ thuật).<br>• C. suitably: dressed suitably (ăn mặc phù hợp).<br><strong>Ghi nhớ:</strong> Behave appropriately."
                    },
                    {
                        id: 7,
                        options: { A: "defend", B: "maintain", C: "preserve", D: "rescue" },
                        correct: "C",
                        explanation: "<strong>Đáp án đúng: C. preserve</strong><br><em>'Preserve heritage'</em> là bảo tồn di sản.<br><strong>Tại sao sai:</strong><br>• A. defend: bảo vệ khỏi tấn công.<br>• B. maintain: duy trì (máy móc/tòa nhà).<br>• D. rescue: giải cứu.<br><strong>Ghi nhớ:</strong> Preserve culture/heritage."
                    },
                    {
                        id: 8,
                        options: { A: "view", B: "sight", C: "look", D: "glimpse" },
                        correct: "D",
                        explanation: "<strong>Đáp án đúng: D. glimpse</strong><br><em>'A glimpse of'</em> là cái nhìn thoáng qua hoặc sự hiểu biết sơ lược về điều gì đó thú vị.<br><strong>Tại sao sai:</strong><br>• A. view: tầm nhìn.<br>• B. sight: thị lực/cảnh tượng.<br><strong>Ghi nhớ:</strong> Collocation: 'catch/get a glimpse of'."
                    }
                ]
            },
            {
                id: 2,
                title: "The Treadwheel Crane",
                content: `In the days before modern machinery, moving heavy objects was hard work. However, the Romans had a clever solution: the treadwheel crane. This machine used human power to lift heavy (0) <span class="gap-slot filled-correct font-bold text-green-700">loads</span>. It consisted of a large wooden wheel, turned by men walking inside it, similar to a hamster in a wheel. The rotation of the wheel wound a rope, lifting the object.<br><br>
                Despite its simple design, the treadwheel crane was surprisingly (1) <span id="gap-2-1" class="gap-slot">......</span> . It could lift weights that would have required dozens of men to pull by hand. This efficiency (2) <span id="gap-2-2" class="gap-slot">......</span> it possible to build the massive cathedrals and castles of the Middle Ages. The cranes were usually placed at the top of the building (3) <span id="gap-2-3" class="gap-slot">......</span> construction, and moved upwards as the building grew.<br><br>
                Working in a treadwheel crane was dangerous (4) <span id="gap-2-4" class="gap-slot">......</span> . If the rope broke or the load was too heavy, the wheel could spin out of control, injuring the workers inside. For this reason, only the most (5) <span id="gap-2-5" class="gap-slot">......</span> workers were chosen for the job. They had to be physically strong and have good (6) <span id="gap-2-6" class="gap-slot">......</span> to walk steadily in the turning wheel. Today, these cranes are rare, but a few surviving examples can still be seen in Europe, offering a fascinating (7) <span id="gap-2-7" class="gap-slot">......</span> into the engineering skills of the past. They serve as a reminder of the (8) <span id="gap-2-8" class="gap-slot">......</span> efforts required to build our historic monuments.`,
                questions: [
                    {
                        id: 1,
                        options: { A: "proficient", B: "effective", C: "capable", D: "expert" },
                        correct: "B",
                        explanation: "<strong>Đáp án đúng: B. effective</strong><br>Máy móc hoạt động 'hiệu quả' (effective).<br><strong>Tại sao sai:</strong><br>• A. proficient: thành thạo (dùng cho người).<br>• C. capable: có khả năng.<br><strong>Ghi nhớ:</strong> Effective solution/method."
                    },
                    {
                        id: 2,
                        options: { A: "resulted", B: "meant", C: "made", D: "caused" },
                        correct: "C",
                        explanation: "<strong>Đáp án đúng: C. made</strong><br>Cấu trúc: <em>'made it possible'</em> (làm cho điều gì đó trở nên khả thi).<br><strong>Tại sao sai:</strong><br>• B. meant: nghĩa là.<br>• D. caused: gây ra.<br><strong>Ghi nhớ:</strong> Make it possible/easy/difficult."
                    },
                    {
                        id: 3,
                        options: { A: "under", B: "in", C: "on", D: "by" },
                        correct: "A",
                        explanation: "<strong>Đáp án đúng: A. under</strong><br>Cụm từ <em>'under construction'</em> nghĩa là đang được xây dựng.<br><strong>Tại sao sai:</strong><br>• B. in construction: không phổ biến.<br><strong>Ghi nhớ:</strong> Idiom: 'under construction'."
                    },
                    {
                        id: 4,
                        options: { A: "business", B: "employment", C: "trade", D: "occupation" },
                        correct: "A",
                        explanation: "<strong>Đáp án đúng: A. business</strong><br><em>'Dangerous business'</em> là một thành ngữ chỉ một việc làm/hoạt động nguy hiểm.<br><strong>Tại sao sai:</strong><br>• D. occupation: nghề nghiệp (trang trọng quá).<br><strong>Ghi nhớ:</strong> Idiom: 'It's a risky/dangerous business'."
                    },
                    {
                        id: 5,
                        options: { A: "experienced", B: "trained", C: "learned", D: "prepared" },
                        correct: "A",
                        explanation: "<strong>Đáp án đúng: A. experienced</strong><br>Những công nhân 'dày dặn kinh nghiệm' (experienced).<br><strong>Tại sao sai:</strong><br>• B. trained: được đào tạo.<br>• C. learned: có học thức.<br><strong>Ghi nhớ:</strong> Experienced worker/staff."
                    },
                    {
                        id: 6,
                        options: { A: "control", B: "scale", C: "balance", D: "weight" },
                        correct: "C",
                        explanation: "<strong>Đáp án đúng: C. balance</strong><br>Cần có 'sự thăng bằng' (balance) tốt để đi bộ trong bánh xe quay.<br><strong>Tại sao sai:</strong><br>• A. control: sự kiểm soát.<br><strong>Ghi nhớ:</strong> Keep/lose your balance."
                    },
                    {
                        id: 7,
                        options: { A: "vision", B: "insight", C: "view", D: "sight" },
                        correct: "B",
                        explanation: "<strong>Đáp án đúng: B. insight</strong><br><em>'Insight into'</em>: cái nhìn sâu sắc/sự thấu hiểu về cái gì.<br><strong>Tại sao sai:</strong><br>• A. vision: tầm nhìn.<br>• C. view: quang cảnh.<br><strong>Ghi nhớ:</strong> Provide/offer an insight into."
                    },
                    {
                        id: 8,
                        options: { A: "extreme", B: "great", C: "heavy", D: "immense" },
                        correct: "D",
                        explanation: "<strong>Đáp án đúng: D. immense</strong><br>Nỗ lực 'to lớn/khổng lồ' (immense efforts).<br><strong>Tại sao sai:</strong><br>• A. extreme: cực đoan.<br>• C. heavy: nặng.<br><strong>Ghi nhớ:</strong> Collocation: 'immense effort/pressure'."
                    }
                ]
            },
            {
                id: 3,
                title: "The Excitement of Advertising",
                content: `To many people, advertising is a nuisance, interrupting their favourite TV programmes. However, to those who work in the industry, it is a (0) <span class="gap-slot filled-correct font-bold text-green-700">creative</span> and exciting world. Advertising agencies are always looking for new ideas to (1) <span id="gap-3-1" class="gap-slot">......</span> the attention of the public. They know that to sell a product, they must make it stand out from the (2) <span id="gap-3-2" class="gap-slot">......</span> .<br><br>
                A successful campaign can make a brand famous overnight. But getting it right is not easy. Advertisers must understand their (3) <span id="gap-3-3" class="gap-slot">......</span> audience and what makes them tick. They conduct extensive market research to (4) <span id="gap-3-4" class="gap-slot">......</span> out what consumers want. This data is then used to design adverts that appeal (5) <span id="gap-3-5" class="gap-slot">......</span> to that group.<br><br>
                The industry is also highly competitive. Agencies compete with each other to win contracts from big companies. The pressure to (6) <span id="gap-3-6" class="gap-slot">......</span> results can be high, and long hours are common. However, the rewards can be great. Top creatives are well-paid and have the satisfaction of seeing their work on billboards and screens everywhere. For those with imagination and ambition, advertising offers a (7) <span id="gap-3-7" class="gap-slot">......</span> career path. It is a field where you can truly make a (8) <span id="gap-3-8" class="gap-slot">......</span> .`,
                questions: [
                    {
                        id: 1,
                        options: { A: "gain", B: "win", C: "catch", D: "hold" },
                        correct: "C",
                        explanation: "<strong>Đáp án đúng: C. catch</strong><br>Cụm từ <em>'catch the attention'</em> (thu hút sự chú ý).<br><strong>Tại sao sai:</strong><br>• A. gain: đạt được.<br>• B. win: chiến thắng.<br>• D. hold: giữ (hold attention cũng đúng nhưng catch mang nghĩa 'thu hút ban đầu' hợp ngữ cảnh tìm ý tưởng mới hơn).<br><strong>Ghi nhớ:</strong> Catch/attract attention."
                    },
                    {
                        id: 2,
                        options: { A: "crowd", B: "group", C: "set", D: "bunch" },
                        correct: "A",
                        explanation: "<strong>Đáp án đúng: A. crowd</strong><br>Thành ngữ <em>'stand out from the crowd'</em> (nổi bật giữa đám đông/khác biệt).<br><strong>Tại sao sai:</strong><br>• B. group/C. set: không dùng trong thành ngữ này.<br><strong>Ghi nhớ:</strong> Idiom: 'stand out from the crowd'."
                    },
                    {
                        id: 3,
                        options: { A: "aim", B: "target", C: "goal", D: "object" },
                        correct: "B",
                        explanation: "<strong>Đáp án đúng: B. target</strong><br><em>'Target audience'</em> là khách hàng mục tiêu.<br><strong>Tại sao sai:</strong><br>• A. aim: mục đích.<br>• C. goal: bàn thắng/mục tiêu.<br><strong>Ghi nhớ:</strong> Marketing term: 'target audience/market'."
                    },
                    {
                        id: 4,
                        options: { A: "know", B: "find", C: "search", D: "learn" },
                        correct: "B",
                        explanation: "<strong>Đáp án đúng: B. find</strong><br>Cụm động từ <em>'find out'</em> (tìm ra/khám phá ra).<br><strong>Tại sao sai:</strong><br>• A. know out: sai.<br>• C. search out: tìm kiếm (ít dùng).<br><strong>Ghi nhớ:</strong> Phrasal verb: 'find out'."
                    },
                    {
                        id: 5,
                        options: { A: "directly", B: "straight", C: "fast", D: "sharp" },
                        correct: "A",
                        explanation: "<strong>Đáp án đúng: A. directly</strong><br>Thu hút 'trực tiếp' (appeal directly) đến nhóm đó.<br><strong>Tại sao sai:</strong><br>• B. straight: thẳng.<br><strong>Ghi nhớ:</strong> Appeal directly to someone."
                    },
                    {
                        id: 6,
                        options: { A: "bring", B: "pass", C: "deliver", D: "offer" },
                        correct: "C",
                        explanation: "<strong>Đáp án đúng: C. deliver</strong><br><em>'Deliver results'</em> là mang lại kết quả (thường dùng trong công việc).<br><strong>Tại sao sai:</strong><br>• A. bring: mang lại (bring about).<br>• B. pass: thông qua.<br><strong>Ghi nhớ:</strong> Deliver results/promises."
                    },
                    {
                        id: 7,
                        options: { A: "promising", B: "rewarding", C: "paying", D: "worth" },
                        correct: "B",
                        explanation: "<strong>Đáp án đúng: B. rewarding</strong><br>Một sự nghiệp 'đáng làm/đem lại nhiều lợi ích tinh thần' (rewarding career).<br><strong>Tại sao sai:</strong><br>• A. promising: đầy hứa hẹn (cho tương lai).<br>• C. paying: high-paying (trả lương cao).<br><strong>Ghi nhớ:</strong> Rewarding job/career."
                    },
                    {
                        id: 8,
                        options: { A: "sign", B: "mark", C: "point", D: "symbol" },
                        correct: "B",
                        explanation: "<strong>Đáp án đúng: B. mark</strong><br>Thành ngữ <em>'make a mark'</em> (để lại dấu ấn/thành công).<br><strong>Tại sao sai:</strong><br>• A. sign: dấu hiệu.<br>• C. point: điểm.<br><strong>Ghi nhớ:</strong> Idiom: 'make your mark'."
                    }
                ]
            },
            {
                id: 4,
                title: "A Good Start",
                content: `We all know that eating a healthy breakfast is important. It gives us the energy we need to (0) <span class="gap-slot filled-correct font-bold text-green-700">start</span> the day. Yet, many people skip breakfast because they are in a (1) <span id="gap-4-1" class="gap-slot">......</span> to get to work or school. Experts warn that this can have serious consequences for our health. Without food, our blood sugar levels drop, making us feel tired and (2) <span id="gap-4-2" class="gap-slot">......</span> to concentrate.<br><br>
                Studies have shown that people who eat breakfast perform better mentally and physically. Children, in particular, need a nutritious meal to help them learn. A good breakfast should (3) <span id="gap-4-3" class="gap-slot">......</span> of carbohydrates, protein, and fruit. Sugary cereals might give you a quick burst of energy, but it won't (4) <span id="gap-4-4" class="gap-slot">......</span> . You will soon feel hungry again.<br><br>
                If you don't have time to cook, there are plenty of quick options. You could prepare some overnight oats the night before, or just grab a piece of fruit and some nuts. The key is to form a (5) <span id="gap-4-5" class="gap-slot">......</span> . Once you get used to eating in the morning, you will realize how much better you feel. It is a small change that can make a big (6) <span id="gap-4-6" class="gap-slot">......</span> to your well-being. So set your alarm ten minutes earlier and (7) <span id="gap-4-7" class="gap-slot">......</span> yourself to a good breakfast. Your body will (8) <span id="gap-4-8" class="gap-slot">......</span> you for it.`,
                questions: [
                    {
                        id: 1,
                        options: { A: "hurry", B: "rush", C: "speed", D: "dash" },
                        correct: "B",
                        explanation: "<strong>Đáp án đúng: B. rush</strong><br>Cụm từ <em>'in a rush'</em> (đang vội). 'In a hurry' cũng đúng nhưng 'rush to get to work' nhấn mạnh sự hối hả.<br><strong>Tại sao sai:</strong><br>• A. hurry: in a hurry (đúng, nhưng rush thường hay đi với văn cảnh đi làm/đi học). Trong FCE, rush thường được chọn.<br><strong>Ghi nhớ:</strong> In a rush/hurry."
                    },
                    {
                        id: 2,
                        options: { A: "impossible", B: "incapable", C: "unable", D: "powerless" },
                        correct: "C",
                        explanation: "<strong>Đáp án đúng: C. unable</strong><br>Cấu trúc: <em>'unable to do something'</em> (không thể làm gì).<br><strong>Tại sao sai:</strong><br>• A. impossible: dùng cho sự vật/sự việc (It is impossible for us).<br>• B. incapable: incapable of doing.<br><strong>Ghi nhớ:</strong> Unable to concentrate."
                    },
                    {
                        id: 3,
                        options: { A: "contain", B: "consist", C: "include", D: "involve" },
                        correct: "B",
                        explanation: "<strong>Đáp án đúng: B. consist</strong><br>Cụm động từ <em>'consist of'</em> (bao gồm).<br><strong>Tại sao sai:</strong><br>• A. contain: không đi với of.<br>• C. include: không đi với of.<br><strong>Ghi nhớ:</strong> Consist of."
                    },
                    {
                        id: 4,
                        options: { A: "last", B: "stay", C: "remain", D: "keep" },
                        correct: "A",
                        explanation: "<strong>Đáp án đúng: A. last</strong><br>Năng lượng sẽ không 'kéo dài' (last).<br><strong>Tại sao sai:</strong><br>• B. stay: ở lại.<br>• D. keep: giữ.<br><strong>Ghi nhớ:</strong> The effect won't last."
                    },
                    {
                        id: 5,
                        options: { A: "routine", B: "custom", C: "habit", D: "practice" },
                        correct: "C",
                        explanation: "<strong>Đáp án đúng: C. habit</strong><br>Cụm từ <em>'form a habit'</em> (hình thành thói quen).<br><strong>Tại sao sai:</strong><br>• A. routine: lịch trình (daily routine).<br>• B. custom: phong tục.<br><strong>Ghi nhớ:</strong> Form/break a habit."
                    },
                    {
                        id: 6,
                        options: { A: "contrast", B: "change", C: "difference", D: "effect" },
                        correct: "C",
                        explanation: "<strong>Đáp án đúng: C. difference</strong><br>Cụm từ <em>'make a difference'</em> (tạo ra sự khác biệt/thay đổi tích cực).<br><strong>Tại sao sai:</strong><br>• B. change: make a change (đúng ngữ pháp nhưng make a difference hay hơn trong ngữ cảnh well-being).<br><strong>Ghi nhớ:</strong> Make a difference to."
                    },
                    {
                        id: 7,
                        options: { A: "provide", B: "treat", C: "give", D: "offer" },
                        correct: "B",
                        explanation: "<strong>Đáp án đúng: B. treat</strong><br><em>'Treat yourself to'</em>: tự thưởng cho bản thân cái gì.<br><strong>Tại sao sai:</strong><br>• A. provide: provide yourself with.<br>• C. give: give yourself something.<br><strong>Ghi nhớ:</strong> Treat yourself to something."
                    },
                    {
                        id: 8,
                        options: { A: "praise", B: "appreciate", C: "thank", D: "bless" },
                        correct: "C",
                        explanation: "<strong>Đáp án đúng: C. thank</strong><br>Cơ thể sẽ 'cảm ơn' bạn (thank you).<br><strong>Tại sao sai:</strong><br>• A. praise: khen ngợi.<br>• B. appreciate: trân trọng (I appreciate it).<br><strong>Ghi nhớ:</strong> Thank someone for something."
                    }
                ]
            }
        ];

        // GLOBAL STATE & LOGIC
        // (Giữ nguyên logic từ Set 2 để đảm bảo tính ổn định)
        let state = {
            currentTestIndex: 0,
            userAnswers: {},
            userName: "",
            startTime: null,
            endTime: null,
            timerInterval: null,
            lockedQuestions: {}, 
            isGlobalPenaltyActive: false
        };

        const dom = {
            welcomeScreen: document.getElementById('welcome-screen'),
            mainApp: document.getElementById('main-app'),
            resultScreen: document.getElementById('result-screen'),
            usernameInput: document.getElementById('username-input'),
            timerDisplay: document.getElementById('timer-display'),
            partTitle: document.getElementById('part-title'),
            progressText: document.getElementById('progress-text'),
            readingText: document.getElementById('reading-text'),
            questionsContainer: document.getElementById('questions-container'),
            btnPrev: document.getElementById('btn-prev'),
            btnNext: document.getElementById('btn-next'),
            btnFinish: document.getElementById('btn-finish'),
            savingStatus: document.getElementById('saving-status')
        };

        function startApp() {
            const name = dom.usernameInput.value.trim();
            if (!name) {
                alert("Please enter your name!");
                return;
            }
            state.userName = name;
            state.startTime = new Date();
            dom.welcomeScreen.classList.add('hidden');
            dom.mainApp.classList.remove('hidden');
            dom.mainApp.classList.add('flex');
            startTimer();
            loadTest(0);
        }

        function startTimer() {
            state.timerInterval = setInterval(() => {
                const now = new Date();
                const diff = now - state.startTime;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                dom.timerDisplay.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function loadTest(index) {
            state.currentTestIndex = index;
            const test = testsData[index];
            dom.partTitle.textContent = `Test ${index + 1}: ${test.title}`;
            dom.progressText.textContent = `${index + 1}/${testsData.length}`;
            dom.readingText.innerHTML = test.content;
            setTimeout(() => restoreTextGaps(index), 0);
            
            dom.questionsContainer.innerHTML = '';
            test.questions.forEach(q => {
                const qKey = `${test.id}-${q.id}`;
                const answerState = state.userAnswers[qKey] || { attempts: 0, correct: null, selected: null };
                const isTempLocked = state.lockedQuestions[qKey] === true;
                const isGlobalLock = state.isGlobalPenaltyActive; 
                
                const qDiv = document.createElement('div');
                let cardClass = "p-5 rounded-2xl border-2 transition-all duration-300 shadow-sm mb-4 relative overflow-hidden ";
                if (answerState.correct === true) cardClass += "border-green-200 bg-green-50/50";
                else if (answerState.correct === false && answerState.attempts >= 2) cardClass += "border-red-100 bg-red-50/50";
                else if (isTempLocked) cardClass += "border-orange-300 bg-orange-50"; 
                else cardClass += "border-white bg-white hover:border-blue-200 hover:shadow-md";

                qDiv.className = cardClass;
                qDiv.id = `q-card-${q.id}`;
                const isFinalLocked = answerState.correct === true || (answerState.correct === false && answerState.attempts >= 2);

                let html = `
                    ${isTempLocked ? '<div class="absolute top-0 left-0 penalty-bar"></div>' : ''}
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center">
                            <span class="w-9 h-9 rounded-full bg-slate-800 text-white font-bold flex items-center justify-center mr-3 shadow-md border-2 border-slate-600 text-lg shadow-slate-300/50">${q.id}</span>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Select Answer</span>
                        </div>
                        ${answerState.attempts === 1 && !isFinalLocked && !isTempLocked && !isGlobalLock ? '<span class="text-[10px] text-orange-600 font-extrabold bg-orange-100 px-2 py-1 rounded-md border border-orange-200 animate-pulse uppercase tracking-wide">⚠️ Retry</span>' : ''}
                        ${isTempLocked ? '<span class="text-[10px] text-orange-600 font-extrabold flex items-center">Think again...</span>' : ''}
                        ${isGlobalLock && !isTempLocked && !isFinalLocked ? '<span class="text-[10px] text-slate-500 font-bold bg-slate-100 px-2 py-1 rounded border border-slate-200">Waiting...</span>' : ''}
                    </div>
                    ${isGlobalLock && !isTempLocked && !isFinalLocked ? '<div class="global-lock-overlay"><span class="text-sm font-bold text-slate-600 bg-white px-3 py-1 rounded shadow-sm border border-slate-200">Please finish the current question...</span></div>' : ''}
                    <div class="grid grid-cols-2 gap-3 mb-2">
                `;

                for (const [key, value] of Object.entries(q.options)) {
                    let btnClass = "option-btn w-full py-3 px-4 rounded-xl border-2 text-[15px] font-semibold text-left flex items-center shadow-sm relative overflow-hidden ";
                    let disabled = false;
                    let icon = `<span class="w-6 h-6 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 text-xs mr-3 font-bold border border-slate-200 group-hover:bg-white group-hover:border-blue-300 transition-colors">${key}</span>`;

                    if (isFinalLocked) {
                        disabled = true;
                        if (key === q.correct) {
                            btnClass += "bg-green-600 text-white border-green-600 shadow-md ring-2 ring-green-200 ring-offset-1";
                            icon = `<span class="w-6 h-6 flex items-center justify-center rounded-full bg-white text-green-700 text-xs mr-3 font-bold">✓</span>`;
                        } else if (key === answerState.selected && answerState.correct === false) {
                            btnClass += "bg-red-500 text-white border-red-500 opacity-80";
                            icon = `<span class="w-6 h-6 flex items-center justify-center rounded-full bg-white text-red-600 text-xs mr-3 font-bold">✕</span>`;
                        } else {
                            btnClass += "bg-slate-50 text-slate-400 border-slate-100 opacity-40";
                        }
                    } else if (isTempLocked) {
                        disabled = true;
                        if (answerState.attempts === 1 && key === answerState.selected) {
                            btnClass += "bg-red-50 text-red-400 border-red-100 cursor-not-allowed opacity-60";
                            icon = `<span class="w-6 h-6 flex items-center justify-center rounded-full bg-red-100 text-red-400 text-xs mr-3 font-bold">✕</span>`;
                        } else {
                            btnClass += "bg-slate-100 text-slate-400 border-slate-200 opacity-70 cursor-wait";
                        }
                    } else if (isGlobalLock) {
                         disabled = true;
                         btnClass += "bg-slate-50 text-slate-300 border-slate-100 opacity-50 cursor-not-allowed grayscale";
                    } else {
                        if (answerState.attempts === 1 && key === answerState.selected) {
                             btnClass += "bg-red-50 text-red-400 border-red-100 cursor-not-allowed opacity-60";
                             icon = `<span class="w-6 h-6 flex items-center justify-center rounded-full bg-red-100 text-red-400 text-xs mr-3 font-bold">✕</span>`;
                             disabled = true;
                        } else {
                             btnClass += "bg-white text-slate-600 border-slate-200 hover:bg-blue-50 hover:border-blue-400 hover:text-blue-700 hover:shadow-md group transition-all active:scale-[0.98]";
                        }
                    }
                    html += `<button onclick="handleAnswer(${index}, ${q.id}, '${key}')" ${disabled ? 'disabled' : ''} class="${btnClass}">${icon}${value}</button>`;
                }
                html += `</div>`;
                if (isFinalLocked) {
                    html += `
                        <div class="mt-4 text-sm p-4 rounded-xl border-l-4 shadow-sm animate-[fadeIn_0.5s] ${answerState.correct ? 'bg-green-100 border-green-500 text-green-900' : 'bg-red-50 border-red-500 text-red-900'}">
                            <div class="flex items-center mb-2"><span class="font-bold text-lg mr-2">${answerState.correct ? '🎉 Correct!' : '😞 Correct answer is ' + q.correct}</span></div>
                            <div class="pt-3 border-t border-black/5 text-slate-700 leading-relaxed text-[15px]"><span class="font-bold text-slate-900 block mb-1 uppercase text-xs tracking-wider opacity-70">Detailed Explanation:</span>${q.explanation}</div>
                        </div>
                    `;
                }
                qDiv.innerHTML = html;
                dom.questionsContainer.appendChild(qDiv);
            });

            dom.btnPrev.disabled = index === 0;
            if (index === 0) dom.btnPrev.classList.add('opacity-30'); else dom.btnPrev.classList.remove('opacity-30');
            if (index === testsData.length - 1) {
                dom.btnNext.classList.add('hidden');
                dom.btnFinish.classList.remove('hidden');
            } else {
                dom.btnNext.classList.remove('hidden');
                dom.btnFinish.classList.add('hidden');
            }
        }

        function restoreTextGaps(testIndex) {
            const test = testsData[testIndex];
            test.questions.forEach(q => {
                const qKey = `${test.id}-${q.id}`;
                const stateAnswer = state.userAnswers[qKey];
                const gapEl = document.getElementById(`gap-${test.id}-${q.id}`);
                if (gapEl && stateAnswer) {
                    gapEl.className = 'gap-slot filled-text'; 
                    if (stateAnswer.attempts === 1 && stateAnswer.correct === null) {
                        gapEl.textContent = q.options[stateAnswer.selected];
                        gapEl.classList.add('filled-wrong');
                    } else if (stateAnswer.correct === true) {
                        gapEl.textContent = q.options[q.correct];
                        gapEl.classList.add('filled-correct');
                    } else if (stateAnswer.correct === false && stateAnswer.attempts >= 2) {
                        gapEl.textContent = q.options[q.correct];
                        gapEl.classList.add('filled-correct'); 
                    }
                }
            });
        }

        function handleAnswer(testIndex, qId, selectedOption) {
            const test = testsData[testIndex];
            const q = test.questions.find(x => x.id === qId);
            const qKey = `${test.id}-${qId}`;
            if (state.lockedQuestions[qKey] || state.isGlobalPenaltyActive) return;

            if (!state.userAnswers[qKey]) state.userAnswers[qKey] = { attempts: 0, correct: null, selected: null };
            const currentAnsState = state.userAnswers[qKey];

            if (selectedOption === q.correct) {
                currentAnsState.correct = true;
                currentAnsState.attempts++;
                currentAnsState.selected = selectedOption;
                saveAndRender(testIndex);
            } else {
                currentAnsState.attempts++;
                currentAnsState.selected = selectedOption;
                if (currentAnsState.attempts >= 2) {
                    currentAnsState.correct = false; 
                    saveAndRender(testIndex);
                } else {
                    currentAnsState.correct = null;
                    state.lockedQuestions[qKey] = true;
                    state.isGlobalPenaltyActive = true;
                    saveAndRender(testIndex); 
                    setTimeout(() => {
                        state.lockedQuestions[qKey] = false;
                        state.isGlobalPenaltyActive = false;
                        saveAndRender(testIndex); 
                    }, 10000);
                }
            }
        }

        function saveAndRender(testIndex) {
            const scrollPos = dom.questionsContainer.scrollTop;
            loadTest(testIndex);
            dom.questionsContainer.scrollTop = scrollPos;
        }
        function prevTest() { if (state.currentTestIndex > 0) loadTest(state.currentTestIndex - 1); }
        function nextTest() { if (state.currentTestIndex < testsData.length - 1) loadTest(state.currentTestIndex + 1); }
        function finishTest() {
            clearInterval(state.timerInterval);
            state.endTime = new Date();
            showResults();
        }

        function showResults() {
            dom.mainApp.classList.add('hidden');
            dom.mainApp.classList.remove('flex');
            dom.resultScreen.classList.remove('hidden');
            document.getElementById('result-name').textContent = state.userName;
            
            const diff = state.endTime - state.startTime;
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            const durationStr = `${minutes} min ${seconds} sec`;
            document.getElementById('result-duration').textContent = durationStr;

            let totalWeightedScore = 0;
            let totalMax = 32;
            let detailsHtml = '';

            testsData.forEach(test => {
                let testCorrectCount = 0;
                let weightedScore = 0;
                test.questions.forEach(q => {
                    const key = `${test.id}-${q.id}`;
                    const ans = state.userAnswers[key];
                    if (ans && ans.correct === true) {
                        testCorrectCount++;
                        if (ans.attempts === 1) weightedScore += 1; else weightedScore += 0.5;
                    }
                });
                totalWeightedScore += weightedScore;
                detailsHtml += `
                    <div class="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                        <div class="flex flex-col"><span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Test ${test.id}</span><span class="font-bold text-slate-700 text-sm truncate w-40 md:w-auto">${test.title}</span></div>
                        <div class="flex items-center"><span class="font-bold text-slate-600 mr-2">${testCorrectCount}/8 correct</span></div>
                    </div>
                `;
            });

            const percentage = (totalWeightedScore / totalMax) * 100;
            const percentageStr = percentage.toFixed(1) + '%';
            document.getElementById('result-score').textContent = totalWeightedScore;
            document.getElementById('result-percentage').textContent = percentageStr;
            document.getElementById('result-details').innerHTML = detailsHtml;

            if (window.saveResultToFirebase) {
                window.saveResultToFirebase({
                    name: state.userName,
                    score: `${totalWeightedScore}/${totalMax}`,
                    percentage: percentage,
                    duration: durationStr
                });
            }

            const messageDisplay = document.getElementById('result-message');
            const headerBar = document.getElementById('result-header-bar');
            const scoreCard = document.getElementById('score-card');
            const actionArea = document.getElementById('action-area');
            const percentDisplay = document.getElementById('result-percentage');

            if (percentage >= 85) {
                messageDisplay.textContent = "🏆 Mastery Achieved! Excellent Job.";
                messageDisplay.className = "text-center mb-8 font-bold text-xl text-green-600";
                headerBar.className = "absolute top-0 left-0 w-full h-3 rounded-t-2xl bg-green-500";
                scoreCard.className = "bg-green-50 p-5 rounded-2xl border border-green-200";
                percentDisplay.className = "ml-auto text-lg font-bold px-2 py-1 rounded bg-white text-green-700 border border-green-200";
                actionArea.innerHTML = `<button onclick="location.reload()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:-translate-y-1">Restart Set</button>`;
            } else {
                messageDisplay.textContent = "⚠️ Not Passed. You need 85% to master this set.";
                messageDisplay.className = "text-center mb-8 font-bold text-xl text-red-500";
                headerBar.className = "absolute top-0 left-0 w-full h-3 rounded-t-2xl bg-red-500";
                scoreCard.className = "bg-red-50 p-5 rounded-2xl border border-red-200";
                percentDisplay.className = "ml-auto text-lg font-bold px-2 py-1 rounded bg-white text-red-700 border border-red-200";
                actionArea.innerHTML = `<button onclick="location.reload()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex justify-center items-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Retry This Set</button>`;
            }
        }
        dom.usernameInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') startApp(); });
    </script>
</body>
</html>
