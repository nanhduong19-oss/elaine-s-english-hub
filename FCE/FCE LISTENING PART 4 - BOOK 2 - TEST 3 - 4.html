<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCE Listening - High Security Exam</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fce: { 
                            50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 
                            500: '#22c55e', 600: '#16a34a', 700: '#15803d', 
                            800: '#166534', 900: '#14532d'
                        }
                    },
                    fontFamily: { sans: ['Quicksand', 'sans-serif'] },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'bounce-subtle': 'bounce 2s infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            /* FCE Green Gradient Background */
            background-image: radial-gradient(#16a34a 0.5px, transparent 0.5px), radial-gradient(#16a34a 0.5px, #f0fdf4 0.5px);
            background-size: 20px 20px;
            overflow: hidden; 
            height: 100vh;
            user-select: none; /* Prevent text selection */
        }

        /* --- APP LAYOUT --- */
        #app {
            display: flex;
            flex-direction: column;
            height: 95vh;
            max-height: 100vh;
        }

        #quiz-header-wrapper {
            flex: none;
            z-index: 50;
            background: rgba(255, 255, 255, 0.98);
            border-bottom: 2px solid #bbf7d0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        #quiz-content-wrapper {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
            position: relative;
        }

        #quiz-footer-wrapper {
            flex: none;
            z-index: 50;
            background: white;
            border-top: 2px solid #f0fdf4;
        }

        /* Audio Player Styling */
        audio { width: 100%; height: 40px; }
        audio::-webkit-media-controls-enclosure { background-color: #f0fdf4; border-radius: 99px; }
        audio::-webkit-media-controls-play-button { background-color: #16a34a; border-radius: 50%; color: white; }

        /* UI Elements */
        .option-btn { transition: all 0.2s; }
        .option-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .option-btn:active:not(:disabled) { transform: translateY(0); }
        
        /* Overlays */
        #penalty-overlay, #fullscreen-blocker { backdrop-filter: blur(12px); }
        
        /* Spam Overlay - Modified for 50% opacity/blur */
        #spam-overlay { backdrop-filter: blur(4px); } 
        
        /* Animations */
        .evidence-box { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .evidence-box.show { max-height: 2000px; opacity: 1; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #bbf7d0; }
        
        .cheat-toast { animation: slideInDown 0.5s forwards; }
        @keyframes slideInDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 20px); opacity: 1; } }

        /* Custom Scrollbar */
        #quiz-content-wrapper::-webkit-scrollbar { width: 8px; }
        #quiz-content-wrapper::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #quiz-content-wrapper::-webkit-scrollbar-thumb { background: #86efac; border-radius: 4px; }
        #quiz-content-wrapper::-webkit-scrollbar-thumb:hover { background: #22c55e; }

        /* SVG Circle Animation for Spam */
        .timer-circle {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        
        /* Script Styling */
        .script-speaker { font-weight: 700; color: #166534; display: block; margin-top: 8px; }
        .script-text { color: #374151; }
        .script-highlight { background-color: #dcfce7; font-weight: 700; padding: 2px 0; }

    </style>
</head>
<body class="flex justify-center items-center w-full">

    <!-- SPAM/SPEED WARNING OVERLAY -->
    <div id="spam-overlay" class="fixed inset-0 z-[120] bg-white/50 hidden flex items-center justify-center">
        <div class="flex flex-col items-center bg-white p-6 rounded-3xl shadow-2xl border border-gray-200">
            <div class="relative w-40 h-40 mb-6">
                <!-- SVG Circle Timer -->
                <svg class="w-full h-full" viewBox="0 0 100 100">
                    <!-- Background Circle -->
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#e5e7eb" stroke-width="8"></circle>
                    <!-- Progress Circle -->
                    <circle id="spam-progress-circle" cx="50" cy="50" r="45" fill="none" stroke="#ea580c" stroke-width="8" 
                            stroke-linecap="round" 
                            stroke-dasharray="283" 
                            stroke-dashoffset="0"
                            class="timer-circle"></circle>
                </svg>
                <!-- Icon in Center -->
                <div class="absolute inset-0 flex items-center justify-center text-4xl">
                    ‚ö°
                </div>
            </div>
            <h3 class="text-3xl font-bold text-gray-800 mb-2">Too Fast!</h3>
            <p class="text-gray-500 font-medium text-lg">Please take your time to think.</p>
            <p class="text-orange-600 font-bold mt-2">System locked for <span id="spam-timer-text">10</span>s</p>
        </div>
    </div>

    <!-- FULLSCREEN BLOCKER OVERLAY -->
    <div id="fullscreen-blocker" class="fixed inset-0 z-[110] bg-white/95 hidden flex flex-col items-center justify-center text-center p-8">
        <div class="bg-red-50 p-8 rounded-3xl border-2 border-red-100 max-w-md w-full shadow-xl">
            <div class="text-6xl mb-6">üñ•Ô∏è</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-3">Full Screen Required</h3>
            <p id="fullscreen-msg" class="text-gray-600 mb-8 font-medium">Please do not minimize the window.<br>You must be in full screen mode to continue.</p>
            <button onclick="resumeFullscreen()" class="w-full py-4 bg-fce-600 text-white font-bold rounded-2xl shadow-lg hover:bg-fce-700 transition transform hover:-translate-y-1 active:scale-95 text-lg flex items-center justify-center gap-2">
                <span>Resume Full Screen</span>
            </button>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app" class="w-full max-w-[95%] xl:max-w-6xl bg-white md:rounded-3xl shadow-2xl relative border border-white overflow-hidden">
        
        <!-- === SCREEN: WELCOME (Updated Design) === -->
        <div id="screen-welcome" class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 text-center space-y-6">
            
            <!-- Icon Box -->
            <div class="bg-white p-5 rounded-3xl shadow-lg mb-2">
                <span class="text-5xl">üìù</span>
            </div>
            
            <!-- Title Section -->
            <div class="space-y-1">
                <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 tracking-tight">Focused Listening Practice</h1>
                <p class="text-green-500 font-bold text-sm tracking-widest uppercase">English Test Mode</p>
            </div>

            <!-- Student Input -->
            <div class="w-full max-w-sm pt-4">
                <div class="text-left space-y-2">
                    <label class="block text-sm font-bold text-slate-600 ml-1">Full Name</label>
                    <input type="text" id="student-name" placeholder="Ex: Nguyen Van A" class="w-full px-5 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none text-slate-700 text-lg transition-all" autocomplete="off">
                </div>
            </div>

            <!-- Warning Box (Updated Style) -->
            <div class="w-full max-w-md bg-yellow-50 rounded-xl border border-yellow-100 p-5 space-y-3">
                <p class="text-slate-700 font-semibold text-base">
                    Please stay focused and take the test seriously
                </p>
                <div class="bg-red-50 rounded-lg border border-red-100 p-3">
                    <p class="text-red-500 font-bold text-xs leading-relaxed">
                        ‚ö†Ô∏è Note: Violating the rules 3 times will automatically terminate the test and submit your current results.
                    </p>
                </div>
            </div>

            <!-- Start Button (Updated Style) -->
            <button onclick="startApp()" class="w-full max-w-xs bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 px-8 rounded-xl shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 active:translate-y-0 flex items-center justify-center gap-2 mt-4">
                <span class="text-lg">Start Exam</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
            </button>
        </div>

        <!-- === QUIZ INTERFACE === -->
        <div id="quiz-interface" class="flex flex-col h-full hidden opacity-0 transition-opacity duration-500">
            <!-- Header (Injected) -->
            <div id="quiz-header-wrapper" class="px-6 py-3"></div>
            <!-- Content (Injected) -->
            <div id="quiz-content-wrapper" class="p-6">
                <div id="quiz-content"></div>
            </div>
            <!-- Footer (Static Structure) -->
            <div id="quiz-footer-wrapper" class="p-4 px-6 flex justify-between items-center bg-gray-50/80 backdrop-blur-sm">
                <div class="text-sm font-semibold text-gray-500 flex flex-col">
                    <div class="flex items-center gap-2">
                        <span>Score:</span>
                        <span id="current-score" class="text-fce-600 text-xl font-bold">0</span>
                    </div>
                    <span id="violation-display" class="text-xs text-fce-700 font-bold bg-fce-100 px-3 py-1 rounded-full border border-fce-200">Status: Good</span>
                </div>
                
                <div class="flex gap-3">
                    <button id="submit-btn" onclick="submitPage()" class="px-8 py-3 bg-gray-800 text-white font-bold rounded-2xl shadow-lg hover:bg-black transition active:scale-95 flex items-center gap-2">
                        <span>Submit Page</span>
                    </button>
                    <button id="next-btn" onclick="nextPage()" class="hidden px-8 py-3 bg-fce-600 text-white font-bold rounded-2xl shadow-lg hover:bg-fce-700 transition active:scale-95 flex items-center gap-2 animate-bounce-subtle">
                        <span>Next Page</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- === SCREEN: RESULT === -->
        <div id="screen-result" class="absolute inset-0 z-40 bg-white hidden flex-col items-center justify-center p-8 text-center space-y-6 overflow-y-auto">
            <h2 class="text-3xl font-bold text-gray-800">Test Results</h2>
            
            <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 w-full max-w-md shadow-sm text-left space-y-4">
                <div class="border-b pb-4">
                    <p class="text-gray-500 text-sm uppercase tracking-wide font-bold">Student</p>
                    <p class="text-xl font-bold text-gray-900" id="res-name">--</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-gray-500 text-sm">Start Time</p>
                        <p class="text-md font-medium text-gray-800" id="res-start-time">--</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">End Time</p>
                        <p class="text-md font-medium text-gray-800" id="res-end-time">--</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 bg-white p-3 rounded-xl border border-gray-100">
                    <div>
                        <p class="text-gray-500 text-sm">Score</p>
                        <p class="text-2xl font-bold text-fce-600" id="res-score">0</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Percentage</p>
                        <p class="text-2xl font-bold text-fce-600" id="res-percent">0%</p>
                    </div>
                </div>

                <div class="bg-red-50 p-4 rounded-xl border border-red-100 flex items-center justify-between">
                    <span class="text-red-800 font-medium text-sm">Violations</span>
                    <span class="font-bold text-red-600 text-xl" id="res-violations">0</span>
                </div>
            </div>
            
            <div id="result-message" class="text-lg font-bold px-6 py-2 rounded-lg text-center"></div>

            <button onclick="location.reload()" class="px-8 py-3 border-2 border-gray-200 text-gray-600 font-bold rounded-full hover:border-fce-500 hover:text-fce-600 hover:bg-fce-50 transition">
                New Test
            </button>
        </div>

    </div>

    <!-- LOGIC -->
    <script>
        // --- DATA ---
        const quizData = [
            {
                id: "page1",
                title: "Test 7: Interview with Jane Brown",
                audio: "https://www.dropbox.com/scl/fi/4x0yhg17ur8qpy02e7mw3/First2_T7_P6.mp3?rlkey=b42fgcex79pthekbhmckqomo1&st=59kx5gb1&raw=1",
                questions: [
                    {
                        id: 24,
                        text: "Why did Jane choose to study at Longley University?",
                        options: [
                            "A. The location suited her.",
                            "B. She knew people there.",
                            "C. The quality of the accommodation was good."
                        ],
                        correct: "A. The location suited her.",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">Now I know you studied home economics at Longley University, Jane. Why did you go there?</span>
                                 <span class="script-speaker">Jane:</span> <span class="script-text">Well some of my friends also studied home economics, and they wanted me to go to the same university as them rather than to Longley. If I‚Äôd done that, I could have shared a flat with them ‚Äì that would‚Äôve been fun but <span class="script-highlight">being closer to home really appealed to me and made getting used to being a student that bit easier.</span></span>`
                    },
                    {
                        id: 25,
                        text: "What did Jane like about her course?",
                        options: [
                            "A. She gained practical experience.",
                            "B. The teachers helped her a great deal.",
                            "C. She learned to work with other people."
                        ],
                        correct: "A. She gained practical experience.",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">And did you enjoy the course?</span>
                                 <span class="script-speaker">Jane:</span> <span class="script-text">I loved it! I‚Äôve always been interested in food chemistry, so that‚Äôs what I specialised in... The university also <span class="script-highlight">made sure we had plenty of opportunities to get out of the classroom and apply things we‚Äôd learnt in theory to real life.</span></span>`
                    },
                    {
                        id: 26,
                        text: "What does Jane say about her food tasting training?",
                        options: [
                            "A. It was a little boring.",
                            "B. It was rather time-consuming.",
                            "C. It was sometimes stressful."
                        ],
                        correct: "C. It was sometimes stressful.",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">I suppose you also learned about things like food tasting?</span>
                                 <span class="script-speaker">Jane:</span> <span class="script-text">A group of us would all have to taste the same dish and try to decide if the general public would like it. As the training got more complex it became harder to agree, and <span class="script-highlight">there were even conflicts at some moments.</span> We had really long arguments about flavours...</span>`
                    },
                    {
                        id: 27,
                        text: "How did Jane feel when she was offered her first job?",
                        options: [
                            "A. excited to be involved in a challenging area",
                            "B. relieved to have been able to find employment",
                            "C. concerned she might not do her work well enough"
                        ],
                        correct: "B. relieved to have been able to find employment",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">And what was your first job after university?</span>
                                 <span class="script-speaker">Jane:</span> <span class="script-text">I worked for a large food company... But there were a lot of applicants and the food industry isn‚Äôt always an easy one to get into, so <span class="script-highlight">I was very aware of how lucky I was.</span></span>`
                    },
                    {
                        id: 28,
                        text: "Jane is proud that in her first job she",
                        options: [
                            "A. came up with her own original idea for a product.",
                            "B. proved that she was capable of working independently.",
                            "C. succeeded in doing something nobody thought she could."
                        ],
                        correct: "B. proved that she was capable of working independently.",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">Is there anything you particularly remember about that first job?</span>
                                 <span class="script-speaker">Jane:</span> <span class="script-text">Yes, I assisted in the development of a new product... It was very different at first to be making decisions on my own and doing things without the support of the people I‚Äôd studied with for three years, <span class="script-highlight">but I coped pretty well, I think.</span></span>`
                    },
                    {
                        id: 29,
                        text: "How did working in Denmark help Jane‚Äôs career?",
                        options: [
                            "A. She made useful contacts.",
                            "B. She came across new recipes.",
                            "C. She found a better job."
                        ],
                        correct: "A. She made useful contacts.",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">Yeah, it must have been exciting! So what did you do next?</span>
                                 <span class="script-speaker">Jane:</span> <span class="script-text">Well that first company sent me to work in Denmark for two years... Part of my job involved visiting local food companies, and <span class="script-highlight">that way I met lots of people I‚Äôm still in touch with who‚Äôve helped me</span> and taught me loads.</span>`
                    },
                    {
                        id: 30,
                        text: "What aspect of her job does Jane enjoy?",
                        options: [
                            "A. the wide variety of activities she does",
                            "B. the opportunity to meet new people",
                            "C. the experience of trying new foods"
                        ],
                        correct: "A. the wide variety of activities she does",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">Out of all the different things you mentioned Jane, there must be some things you enjoy more than others?</span>
                                 <span class="script-speaker">Jane:</span> <span class="script-text">There are lots of different things I have to do. For example I have to interview clients... I taste food... And then there are reports to write... And lots of other things too, so <span class="script-highlight">every day is different.</span></span>`
                    }
                ]
            },
            {
                id: "page2",
                title: "Test 8: Interview with Maggie Wharton",
                audio: "https://www.dropbox.com/scl/fi/m9rsum8nme097g31wmzfk/First2_T8_P6.mp3?rlkey=gfqkd7brbqi354xjiq9dp44f4&st=8i42el6m&raw=1",
                questions: [
                    {
                        id: 24,
                        text: "Maggie says it took her a long time to learn to kitesurf because",
                        options: [
                            "A. the equipment wasn‚Äôt widely available.",
                            "B. it was hard to find the right assistance.",
                            "C. she needed to build up her strength."
                        ],
                        correct: "B. it was hard to find the right assistance.",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">So Maggie, welcome to the studio. Tell us about the sport of kitesurfing. What is it and how did you get into it?</span>
                                 <span class="script-speaker">Maggie:</span> <span class="script-text">...From the point when I started, a long time ago, it took me about a year to feel I could really call myself a kitesurfer. At least I was physically in good enough shape from the outset, though <span class="script-highlight">the lack of any really suitable instruction obstructed my progress.</span></span>`
                    },
                    {
                        id: 25,
                        text: "In Maggie‚Äôs opinion, since she began kitesurfing",
                        options: [
                            "A. suitable locations have been more clearly identified.",
                            "B. attitudes to some aspects of safety have changed.",
                            "C. participants have become better informed about sea conditions."
                        ],
                        correct: "B. attitudes to some aspects of safety have changed.",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">So what‚Äôs changed in the sport during that time?</span>
                                 <span class="script-speaker">Maggie:</span> <span class="script-text">Well, <span class="script-highlight">helmets have gained increasing popularity,</span> and I guess they‚Äôre good, because if you fall off you could easily hit your head, <span class="script-highlight">but my generation never felt the need for one.</span></span>`
                    },
                    {
                        id: 26,
                        text: "Maggie hopes that by competing in Fiji, she will",
                        options: [
                            "A. encourage others to take up the sport.",
                            "B. have the chance to pick up some new moves.",
                            "C. be invited to start organising future events."
                        ],
                        correct: "A. encourage others to take up the sport.",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">Right ‚Äì and you now take part in international events.</span>
                                 <span class="script-speaker">Maggie:</span> <span class="script-text">Yes, I‚Äôm going to Fiji soon... And <span class="script-highlight">it‚Äôll be great if, as a result of seeing me take part, people will decide to give it a go.</span></span>`
                    },
                    {
                        id: 27,
                        text: "During one distance event, Maggie became slightly worried when",
                        options: [
                            "A. she had to switch to different equipment.",
                            "B. she experienced a great deal of pain.",
                            "C. she lost sight of the people helping her."
                        ],
                        correct: "C. she lost sight of the people helping her.",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">But you‚Äôve done some amazing distance events before.</span>
                                 <span class="script-speaker">Maggie:</span> <span class="script-text">Yeah, I‚Äôve kitesurfed well over a hundred kilometres... And the fog meant <span class="script-highlight">my support boat was no longer visible for a while, which was an uncomfortable feeling.</span></span>`
                    },
                    {
                        id: 28,
                        text: "Maggie thinks her success is due to the fact that",
                        options: [
                            "A. the sport suits her character very well.",
                            "B. her family have given her a lot of support.",
                            "C. she has the opportunity to practise regularly."
                        ],
                        correct: "A. the sport suits her character very well.",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">An amazing achievement! So why‚Äôve you done so well, do you think?</span>
                                 <span class="script-speaker">Maggie:</span> <span class="script-text">Well... <span class="script-highlight">It was the unpredictability of kitesurfing that appealed to my nature, really</span> ‚Äì I‚Äôve always gone for things that are less straightforward.</span>`
                    },
                    {
                        id: 29,
                        text: "Maggie says that some new kitesurfers she‚Äôs met",
                        options: [
                            "A. are likely to develop the sport in interesting ways.",
                            "B. are unwilling to focus on basic techniques first of all.",
                            "C. are too worried about the rules of the sport."
                        ],
                        correct: "B. are unwilling to focus on basic techniques first of all.",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">And kitesurfing‚Äôs a growing sport. What do you think about the people taking it up now?</span>
                                 <span class="script-speaker">Maggie:</span> <span class="script-text">...What they don‚Äôt realise is that as <span class="script-highlight">dos and don‚Äôts of the sport have to be mastered before they try something so ambitious ‚Äì they‚Äôre too impatient</span>...</span>`
                    },
                    {
                        id: 30,
                        text: "What does Maggie hope to do in the future?",
                        options: [
                            "A. find sources of investment for her sport",
                            "B. continue to compete at a high level",
                            "C. set up a kitesurfing school"
                        ],
                        correct: "A. find sources of investment for her sport",
                        script: `<span class="script-speaker">Interviewer:</span> <span class="script-text">What is there left for you to do in the sport?</span>
                                 <span class="script-speaker">Maggie:</span> <span class="script-text">Enjoy it, mostly... But I still need to set myself goals, and <span class="script-highlight">I‚Äôm keen to help bring a bit more sponsorship into the sport</span> without making it too commercial.</span>`
                    }
                ]
            }
        ];

        // --- STATE & VARIABLES ---
        let currentPageIndex = 0;
        let userAnswers = {}; 
        let currentScore = 0;
        let violationCount = 0;
        let startTime = null;
        let endTime = null;
        let studentName = "";
        
        let lastClickTime = 0;
        let isSpamLocked = false;
        let isExamActive = false;
        let fullscreenPollInterval = null;
        
        const SPAM_THRESHOLD = 3000; // 3s
        const SPAM_LOCK_DURATION = 10; // 10s
        const MAX_VIOLATIONS = 3;

        // --- CORE FUNCTIONS ---
        function startApp() {
            // 1. IMMEDIATE FULLSCREEN REQUEST (Must be first line to catch user gesture)
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => console.log("Fullscreen failed:", err));
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            }

            const nameInput = document.getElementById('student-name');
            if (!nameInput.value.trim()) {
                alert("Please enter your name.");
                nameInput.focus();
                return;
            }
            studentName = nameInput.value.trim();
            isExamActive = true;
            startTime = new Date();

            // 2. Setup Monitoring
            setupAntiCheat();

            // 3. UI Transition
            document.getElementById('screen-welcome').classList.add('hidden');
            const quizInterface = document.getElementById('quiz-interface');
            quizInterface.classList.remove('hidden');
            setTimeout(() => quizInterface.classList.remove('opacity-0'), 50);
            
            renderPage(0);
        }

        function resumeFullscreen() {
            const elem = document.documentElement;
            const req = elem.requestFullscreen || elem.webkitRequestFullscreen || elem.msRequestFullscreen;
            if (req) {
                req.call(elem).then(() => {
                    document.getElementById('fullscreen-blocker').classList.add('hidden');
                    // Reset Message
                    document.getElementById('fullscreen-msg').innerHTML = "Please do not minimize the window.<br>You must be in full screen mode to continue.";
                }).catch(err => {
                    console.log("Fullscreen request failed:", err);
                });
            }
        }

        function setupAntiCheat() {
            // 1. Visibility (Tabs)
            document.addEventListener("visibilitychange", () => {
                if (document.hidden && isExamActive) recordViolation("Left quiz tab");
            });
            
            // 2. Focus (Blur) - NEW: Detects Alt+Tab or Window Switching stricter
            window.addEventListener('blur', () => {
                if (isExamActive) recordViolation("Switched Window/App (Alt+Tab)");
            });

            // 3. API Fullscreen Event
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);

            // 4. RESIZE/MINIMIZE POLLING
            if (fullscreenPollInterval) clearInterval(fullscreenPollInterval);
            fullscreenPollInterval = setInterval(checkFullscreenState, 1000);
        }

        function handleFullscreenChange() {
            if (document.fullscreenElement || document.webkitFullscreenElement) {
                 document.getElementById('fullscreen-blocker').classList.add('hidden');
            } else if (isExamActive) {
                recordViolation("Exited fullscreen");
                document.getElementById('fullscreen-blocker').classList.remove('hidden');
            }
        }

        function checkFullscreenState() {
            if (!isExamActive) return;

            const isApiFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
            // Check dimensions (allow 10px buffer)
            const isScreenFull = (window.innerWidth >= screen.width - 10) && (window.innerHeight >= screen.height - 10);

            // If NOT in API Fullscreen AND NOT matching screen dimensions -> Violation
            if (!isApiFullscreen && !isScreenFull) {
                if (document.getElementById('fullscreen-blocker').classList.contains('hidden')) {
                    recordViolation("Window resized/minimized");
                    
                    document.getElementById('fullscreen-msg').innerHTML = 
                        "<strong class='text-red-600'>System Alert:</strong> Window resizing/minimizing detected.<br>Please return to full screen mode immediately.";
                    
                    document.getElementById('fullscreen-blocker').classList.remove('hidden');
                }
            }
        }

        function recordViolation(reason) {
            violationCount++;
            
            if (violationCount >= MAX_VIOLATIONS) {
                clearInterval(fullscreenPollInterval);
                alert(`Violation limit reached (${violationCount}/${MAX_VIOLATIONS}). The exam is terminated.`);
                showResult();
                return;
            }

            const statusEl = document.getElementById('violation-display');
            statusEl.innerText = `Violations: ${violationCount} / ${MAX_VIOLATIONS} ‚ö†Ô∏è`;
            statusEl.className = "text-xs text-red-600 font-bold bg-red-50 px-3 py-1 rounded-full border border-red-200 animate-pulse";
            showToast(`Warning #${violationCount}: ${reason}`);
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'cheat-toast fixed top-6 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-full shadow-2xl z-[100] font-bold text-sm border-2 border-white';
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function formatTime(date) {
            if (!date) return "--";
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} - ${hours}:${minutes}`;
        }

        function renderPage(index) {
            currentPageIndex = index;
            const data = quizData[index];
            const headerWrapper = document.getElementById('quiz-header-wrapper');
            const content = document.getElementById('quiz-content');

            // Header Content
            headerWrapper.innerHTML = `
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <div class="flex items-center gap-3 w-full md:w-auto min-w-[200px]">
                        <span class="bg-fce-600 text-white font-bold px-3 py-1.5 rounded-lg text-sm shadow-sm whitespace-nowrap">Part 4</span>
                        <h2 class="text-lg font-bold text-gray-800 line-clamp-1">${data.title}</h2>
                    </div>
                    <div class="w-full flex-1">
                        <audio id="audio-player" controls controlsList="nodownload" class="shadow-inner w-full">
                            <source src="${data.audio}" type="audio/mpeg">
                        </audio>
                    </div>
                </div>
            `;

            let html = `<div class="flex flex-col space-y-8 max-w-4xl mx-auto">`;
            
            data.questions.forEach(q => {
                html += `
                    <div id="q-box-${q.id}" class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex gap-3 mb-4">
                            <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-fce-100 text-fce-700 font-bold rounded-full text-sm border border-fce-200">${q.id}</span>
                            <h3 class="font-bold text-gray-800 pt-1 text-lg">${q.text}</h3>
                        </div>
                        <div class="grid grid-cols-1 gap-3 mb-4 pl-11">
                            ${q.options.map(opt => `
                                <button onclick="selectOption(${q.id}, '${opt.replace(/'/g, "\\'")}')" 
                                        id="btn-${q.id}-${opt.replace(/'/g, "\\'")}" 
                                        class="option-btn w-full text-left py-3 px-4 rounded-xl border-2 border-gray-100 font-medium text-gray-600 hover:border-fce-300 hover:bg-fce-50 focus:outline-none bg-white">
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                        <div id="feedback-${q.id}" class="hidden flex items-center gap-2 text-sm font-bold mb-3 pl-11 animate-pulse"></div>
                        <div id="evidence-${q.id}" class="evidence-box bg-fce-50 rounded-xl ml-11">
                            <div class="p-4 border-l-4 border-fce-500 text-sm text-gray-700 leading-relaxed text-justify">
                                <span class="block text-xs uppercase font-bold text-fce-600 mb-2">Transcript Evidence</span>
                                ${q.script}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            content.innerHTML = html;
            document.getElementById('quiz-content-wrapper').scrollTop = 0;
            
            // Buttons logic
            document.getElementById('submit-btn').classList.remove('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            
            // Re-assign Submit Button onclick handler based on page
            const submitBtn = document.getElementById('submit-btn');
            if(index === quizData.length - 1) {
                 submitBtn.innerHTML = "<span>Submit & Finish</span>";
                 submitBtn.onclick = submitPage; 
            } else {
                 submitBtn.innerHTML = "<span>Submit Page</span>";
                 submitBtn.onclick = submitPage;
            }
        }

        // --- INTERACTION LOGIC ---
        function selectOption(qId, option) {
            const stateKey = `${currentPageIndex}_${qId}`;
            
            // Checks: Global Lock (Blocker), Spam Lock, Question Locked
            if (document.getElementById('fullscreen-blocker').classList.contains('hidden') === false) return;
            if (isSpamLocked) return;
            if (userAnswers[stateKey]?.locked) return;

            // Spam Click Detection
            const now = Date.now();
            if (lastClickTime > 0 && (now - lastClickTime < SPAM_THRESHOLD)) {
                triggerSpamLock(); 
                return;
            }
            lastClickTime = now;

            // Visual Selection
            // 1. Reset all buttons for this question
            document.querySelectorAll(`[id^="btn-${qId}-"]`).forEach(btn => 
                btn.className = "option-btn w-full text-left py-3 px-4 rounded-xl border-2 border-gray-100 font-medium text-gray-600 hover:border-fce-300 hover:bg-fce-50 focus:outline-none bg-white");
            
            // 2. Highlight selected
            const safeOption = option.replace(/'/g, "\\'"); 
            const selectedBtn = document.getElementById(`btn-${qId}-${safeOption}`);
            if(selectedBtn) {
                selectedBtn.className = "option-btn w-full text-left py-3 px-4 rounded-xl border-2 border-fce-500 bg-fce-50 text-fce-800 font-bold shadow-sm transform scale-[1.01]";
            }

            // Save State
            if (!userAnswers[stateKey]) userAnswers[stateKey] = { attempts: 0, pointsFlag: true };
            userAnswers[stateKey].selected = option;
        }

        function triggerSpamLock() {
            isSpamLocked = true;
            const overlay = document.getElementById('spam-overlay');
            const timerText = document.getElementById('spam-timer-text');
            const progressCircle = document.getElementById('spam-progress-circle');
            
            let timeLeft = SPAM_LOCK_DURATION;
            // Circumference of r=45 is ~283
            const circumference = 283; 
            
            overlay.classList.remove('hidden');
            timerText.innerText = timeLeft;
            progressCircle.style.strokeDashoffset = '0'; // Start full
            
            // Start Animation
            let startTime = Date.now();
            const interval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                timeLeft = Math.max(0, Math.ceil(SPAM_LOCK_DURATION - elapsed));
                timerText.innerText = timeLeft;

                // Update Circle
                const offset = (elapsed / SPAM_LOCK_DURATION) * circumference;
                progressCircle.style.strokeDashoffset = offset;

                if (elapsed >= SPAM_LOCK_DURATION) {
                    clearInterval(interval);
                    overlay.classList.add('hidden');
                    isSpamLocked = false;
                    lastClickTime = 0;
                }
            }, 100);
        }

        function submitPage() {
            const currentData = quizData[currentPageIndex];
            let pageComplete = true; 
            let hasUnanswered = false;
            
            // Check for unanswered
            for (let q of currentData.questions) {
                const key = `${currentPageIndex}_${q.id}`;
                if ((!userAnswers[key] || !userAnswers[key].selected) && !userAnswers[key]?.locked) hasUnanswered = true;
            }
            if (hasUnanswered) { alert("Please answer all questions before submitting."); return; }

            // Process Answers
            currentData.questions.forEach(q => {
                const key = `${currentPageIndex}_${q.id}`;
                const record = userAnswers[key];
                if (record.locked) return; // Already graded

                const safeSelected = record.selected.replace(/'/g, "\\'");
                const safeCorrect = q.correct.replace(/'/g, "\\'");

                const btn = document.getElementById(`btn-${q.id}-${safeSelected}`);
                const feedback = document.getElementById(`feedback-${q.id}`);
                const evidence = document.getElementById(`evidence-${q.id}`);

                // Compare strings
                if (record.selected === q.correct) {
                    // CORRECT
                    btn.className = "w-full text-left py-3 px-4 rounded-xl border-2 border-green-500 bg-green-100 text-green-800 font-bold shadow-sm";
                    feedback.innerHTML = `<span class="text-green-700 bg-green-50 px-2 py-1 rounded border border-green-200">‚úÖ Correct</span>`;
                    feedback.classList.remove('hidden');
                    evidence.classList.add('show');
                    record.locked = true;
                    if (record.pointsFlag) { currentScore++; updateScore(); }
                } else {
                    // WRONG
                    record.attempts++;
                    record.pointsFlag = false;
                    
                    if (record.attempts < 2) {
                        // 1st Fail -> Retry allowed
                        btn.className = "w-full text-left py-3 px-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-400 cursor-not-allowed opacity-60";
                        btn.disabled = true;
                        feedback.innerHTML = `<span class="text-orange-600 bg-orange-50 px-2 py-1 rounded border border-orange-200">‚ö†Ô∏è Incorrect. Try again!</span>`;
                        feedback.classList.remove('hidden');
                        pageComplete = false;
                        record.selected = null; // Reset selection for next try
                        lastClickTime = 0; // Reset spam timer to allow immediate click
                    } else {
                        // 2nd Fail -> Locked
                        btn.className = "w-full text-left py-3 px-4 rounded-xl border-2 border-red-500 bg-red-100 text-red-800 font-bold";
                        
                        // Show Correct Answer
                        const correctBtn = document.getElementById(`btn-${q.id}-${safeCorrect}`);
                        if(correctBtn) correctBtn.className = "w-full text-left py-3 px-4 rounded-xl border-2 border-green-500 bg-white text-green-700 font-bold border-dashed";
                        
                        feedback.innerHTML = `<span class="text-red-600 bg-red-50 px-2 py-1 rounded border border-red-200">‚ùå Incorrect. Answer: ${q.correct.charAt(0)}</span>`;
                        feedback.classList.remove('hidden');
                        evidence.classList.add('show');
                        record.locked = true;
                    }
                }
            });

            if (pageComplete) {
                // If this is the last page, we change the button to "View Results"
                if (currentPageIndex === quizData.length - 1) {
                    const submitBtn = document.getElementById('submit-btn');
                    // BUG FIX: Change styling and logic explicitly here
                    submitBtn.innerHTML = `<span>View Results</span>`;
                    submitBtn.classList.replace('bg-gray-800', 'bg-gray-900'); // Make it look distinct
                    submitBtn.onclick = function() {
                        showResult(); // Direct call
                    };
                } else {
                    document.getElementById('submit-btn').classList.add('hidden');
                    document.getElementById('next-btn').classList.remove('hidden');
                }
            }
        }

        function nextPage() { 
            if (currentPageIndex < quizData.length - 1) {
                renderPage(currentPageIndex + 1); 
            }
        }

        function updateScore() { 
            document.getElementById('current-score').innerText = currentScore; 
        }
        
        function showResult() {
            // Stop Audio immediately
            const audio = document.getElementById('audio-player');
            if(audio) {
                audio.pause();
                audio.currentTime = 0;
            }

            isExamActive = false; // Stop monitoring
            endTime = new Date();
            
            // Stop polling
            if (fullscreenPollInterval) clearInterval(fullscreenPollInterval);

            // Hide Overlays
            document.getElementById('fullscreen-blocker').classList.add('hidden');
            document.getElementById('penalty-overlay')?.classList.add('hidden'); // Optional check
            document.getElementById('spam-overlay').classList.add('hidden');
            
            document.getElementById('quiz-interface').classList.add('hidden');
            const resScreen = document.getElementById('screen-result');
            resScreen.classList.remove('hidden');
            resScreen.style.display = 'flex';

            // Calculate Stats
            const totalQuestions = quizData.reduce((acc, curr) => acc + curr.questions.length, 0);
            const pct = Math.round((currentScore/totalQuestions)*100);
            
            document.getElementById('res-name').innerText = studentName;
            document.getElementById('res-score').innerText = `${currentScore}/${totalQuestions}`;
            document.getElementById('res-percent').innerText = `${pct}%`;
            document.getElementById('res-violations').innerText = violationCount;
            document.getElementById('res-start-time').innerText = formatTime(startTime);
            document.getElementById('res-end-time').innerText = formatTime(endTime);

            const msg = document.getElementById('result-message');
            // Changed logic for pass to 85%
            if(pct >= 85) { 
                msg.innerHTML = "üéâ Excellent! You passed.";
                msg.className = "text-lg font-bold px-6 py-2 rounded-lg bg-green-100 text-green-800 border border-green-200";
            } else {
                msg.innerHTML = "You need 85% to pass";
                msg.className = "text-lg font-bold px-6 py-2 rounded-lg bg-red-50 text-red-800 border border-red-100";
            }
        }
    </script>
</body>
</html>