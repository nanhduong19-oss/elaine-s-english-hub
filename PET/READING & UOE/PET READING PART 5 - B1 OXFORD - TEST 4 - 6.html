<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PET Reading Part 5 - Set 4 (Mastery Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Font: Plus Jakarta Sans */
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Gap Styles inside Text */
        .gap-slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 24px;
            padding: 0 6px;
            margin: 0 2px;
            border-radius: 4px;
            background-color: #f1f5f9;
            color: #64748b;
            font-weight: 700;
            font-size: 0.9em;
            border: 1px solid #e2e8f0;
            cursor: default;
            transition: all 0.2s;
        }
        .gap-slot.filled-correct { background-color: #dcfce7; color: #15803d; border-color: #86efac; }
        .gap-slot.filled-wrong { background-color: #fee2e2; color: #b91c1c; border-color: #fca5a5; }
        .gap-slot.example { background-color: #dcfce7; color: #15803d; border-color: #86efac; font-weight: 800; }

        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        
        .progress-bar-transition { transition: width 0.1s linear; }

        /* --- FIX SCROLL JUMPING (CRITICAL) --- */
        #questions-container {
            overflow-anchor: none !important; /* Ngăn trình duyệt tự động trượt */
        }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col text-slate-800 overflow-hidden">

    <!-- SCREEN 1: WELCOME (ROSE THEME) -->
    <div id="screen-welcome" class="fixed inset-0 z-50 bg-slate-50 flex items-center justify-center p-4">
        <div class="bg-white max-w-md w-full rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
            <div class="h-2 bg-rose-500 w-full"></div>
            <div class="p-8 text-center">
                <h1 class="text-3xl font-extrabold text-slate-800 mb-2">PET Reading Part 5</h1>
                <p class="text-slate-500 mb-6 font-medium">SET 4 (Practice Tests 4 - 6)</p>
                
                <div class="inline-block bg-orange-100 text-orange-700 px-4 py-1 rounded-full text-xs font-bold tracking-wider mb-8">
                    MASTERY STUDY MODE
                </div>

                <div class="text-left mb-6">
                    <label class="block text-sm font-bold text-slate-700 mb-2 ml-1">Your Name</label>
                    <input type="text" id="user-name-input" placeholder="Enter your name..." 
                        class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-rose-500 focus:border-rose-500 outline-none transition-all text-slate-800 font-medium"
                        onkeypress="if(event.key === 'Enter') app.startExam()">
                </div>

                <button onclick="app.startExam()" class="w-full bg-rose-600 hover:bg-rose-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-rose-200 transition-transform active:scale-[0.98]">
                    Start Practice
                </button>
            </div>
            
            <div class="bg-slate-50 p-6 border-t border-slate-100">
                <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase flex items-center gap-2">
                    <i class="fas fa-info-circle text-slate-400"></i> Mastery Rules
                </h3>
                <ul class="space-y-3 text-sm font-medium">
                    <li class="flex items-start gap-3">
                        <i class="fas fa-check text-green-500 mt-0.5"></i>
                        <span class="text-slate-600"><strong class="text-green-700">1st Try Correct:</strong> Full points (100%).</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i class="fas fa-exclamation-triangle text-orange-500 mt-0.5"></i>
                        <span class="text-slate-600"><strong class="text-orange-600">1st Try Wrong:</strong> 10s Penalty Wait + Global Lock. Score reduced to 50%.</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i class="fas fa-times text-red-500 mt-0.5"></i>
                        <span class="text-slate-600"><strong class="text-red-600">2nd Try Wrong:</strong> 0 points. Answer revealed.</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i class="fas fa-star text-rose-500 mt-0.5"></i>
                        <span class="text-slate-600"><strong class="text-rose-700">Target:</strong> You need 85% score to pass.</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- SCREEN 2: MAIN APP -->
    <div id="screen-app" class="hidden flex-col h-full">
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 h-16 flex-none z-20">
            <div class="h-full max-w-[1920px] mx-auto px-6 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="px-3 py-1 bg-rose-50 border border-rose-200 rounded-lg text-rose-700 font-mono font-bold text-sm flex items-center gap-2">
                        <i class="far fa-clock"></i> <span id="timer-display">00:00:00</span>
                    </div>
                    <h2 id="header-title" class="font-bold text-slate-800 text-lg truncate">Test 4</h2>
                </div>

                <div class="flex items-center gap-6">
                     <div class="text-right hidden md:block">
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Candidate</p>
                        <p id="header-name" class="font-bold text-slate-700 text-sm">Student</p>
                    </div>
                    <div class="h-8 w-px bg-slate-200 hidden md:block"></div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mr-1">Progress</span>
                        <span id="header-progress" class="font-bold text-xl text-slate-800">1/3</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="app.navTest(-1)" id="btn-prev" class="w-9 h-9 rounded-full border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-50 hover:text-rose-600 disabled:opacity-30 transition-colors">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button onclick="app.navTest(1)" id="btn-next" class="w-9 h-9 rounded-full border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-50 hover:text-rose-600 transition-colors">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex overflow-hidden bg-slate-100">
            <div class="max-w-[1600px] w-full mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
                
                <!-- LEFT: TEXT -->
                <div class="lg:col-span-6 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
                    <div class="p-8 overflow-y-auto custom-scrollbar flex-grow">
                        <div id="reading-text" class="text-lg leading-8 text-slate-700 text-justify font-normal">
                            <!-- Text injected here -->
                        </div>
                    </div>
                </div>

                <!-- RIGHT: QUESTIONS -->
                <div class="lg:col-span-6 flex flex-col h-full overflow-hidden">
                    <div class="bg-white rounded-t-2xl border-b border-slate-100 p-4 flex justify-between items-center bg-white shadow-sm z-10">
                        <h3 class="font-bold text-rose-600 flex items-center gap-2">
                            <i class="far fa-file-alt"></i> QUESTIONS
                        </h3>
                        <span class="text-[10px] font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded border border-orange-100 tracking-wider">STUDY MODE</span>
                    </div>
                    
                    <div id="questions-container" class="flex-grow overflow-y-auto custom-scrollbar bg-slate-50/50 p-4 space-y-4">
                        <!-- Questions injected here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SCREEN 3: RESULT -->
    <div id="screen-result" class="hidden fixed inset-0 z-50 bg-slate-50 overflow-y-auto custom-scrollbar">
        <div class="min-h-screen w-full flex items-start justify-center p-6 md:py-12">
            <div class="max-w-3xl w-full flex flex-col gap-6">
                
                <!-- Title -->
                <div class="text-center mb-2">
                    <h1 class="text-4xl font-extrabold text-slate-800">Study Mode Results</h1>
                    <div id="result-status-msg" class="flex items-center justify-center gap-2 mt-3 font-bold text-lg"></div>
                </div>

                <!-- Top Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-rose-50/50 border border-rose-100 rounded-2xl p-6 flex flex-col justify-between h-32 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-rose-500"></div>
                        <p class="text-xs font-bold text-rose-500 uppercase tracking-wider">Candidate</p>
                        <p id="result-candidate" class="text-2xl font-bold text-slate-800 truncate">Student</p>
                    </div>

                    <div class="bg-red-50/50 border border-red-100 rounded-2xl p-6 flex flex-col justify-center h-32 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-red-400"></div>
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-xs font-bold text-red-500 uppercase tracking-wider mb-1">Mastery Score</p>
                                <div class="flex items-baseline gap-1">
                                    <span id="result-score" class="text-4xl font-extrabold text-slate-800">0</span>
                                    <span class="text-slate-400 font-medium text-lg">/ 18</span>
                                </div>
                            </div>
                            <div class="bg-white px-3 py-1 rounded-lg border border-red-100 shadow-sm">
                                <span id="result-percent" class="text-lg font-extrabold text-red-600">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Retry Button Rose/Red -->
                <button onclick="location.reload()" class="w-full bg-rose-600 hover:bg-rose-700 text-white text-lg font-bold py-4 rounded-xl shadow-lg shadow-rose-200 transition-all active:scale-[0.99] flex items-center justify-center gap-2">
                    <i class="fas fa-redo-alt"></i> Retry This Set
                </button>

                <!-- Stats Container -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-2">
                        <i class="far fa-clock text-slate-400"></i>
                        <h3 class="font-bold text-slate-700 text-sm">Performance Stats</h3>
                    </div>
                    <div class="p-6 flex justify-between items-center">
                        <span class="text-slate-500 font-medium">Duration:</span>
                        <span id="result-duration" class="font-bold text-slate-800">00 min 00 sec</span>
                    </div>
                </div>

                <!-- Detailed Breakdown -->
                <div id="result-list" class="space-y-3"></div>

            </div>
        </div>
    </div>

    <script>
        // --- Sound Effects System ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration, vol = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }
        function playSound(type) {
            if (type === 'correct') { playTone(600, 'sine', 0.1); setTimeout(() => playTone(900, 'sine', 0.15), 100); }
            else if (type === 'wrong') { playTone(200, 'sawtooth', 0.2, 0.2); }
        }

        // --- Explanation Template ---
        const formatExplanation = (correct, whyCorrect, whyWrong, note) => {
            return `
                <div class="space-y-3">
                    <div class="flex gap-2 text-sm">
                        <span class="font-bold text-green-700 shrink-0">Đáp án đúng:</span>
                        <span class="text-slate-700">${correct} - ${whyCorrect}</span>
                    </div>
                    <div class="text-sm">
                        <span class="font-bold text-red-600 block mb-1">Tại sao các đáp án khác sai:</span>
                        <ul class="list-disc pl-5 text-slate-600 space-y-1">${whyWrong}</ul>
                    </div>
                    ${note ? `<div class="text-sm bg-blue-50 p-2 rounded border border-blue-100 text-slate-700"><span class="font-bold text-blue-700">Ghi nhớ:</span> ${note}</div>` : ''}
                </div>
            `;
        };

        // --- DATA SET 4 (TESTS 4-6) ---
        const db = [
            {
                id: "test4",
                title: "Youth Cafés", 
                text: "In many parts of the UK, there are few places for young people to go that are entertaining but cost little. The <span id='gap-test4-21' class='gap-slot'>(21)............</span> of youth cafés is one that has grown in recent years. The cafés are places <span id='gap-test4-22' class='gap-slot'>(22)............</span> young people can relax in a safe environment.<br><br>People come for different reasons. Some want to socialize with their friends. Others like to <span id='gap-test4-23' class='gap-slot'>(23)............</span> part in the activities offered. Others are <span id='gap-test4-24' class='gap-slot'>(24)............</span> on using the computers and facilities.<br><br>The cafés are set up by young people for young people with adult support. For this reason, the cafes are being planned by young people who <span id='gap-test4-25' class='gap-slot'>(25)............</span> be involved in doing the research, the planning and the general decision-making. In this <span id='gap-test4-26' class='gap-slot'>(26)............</span>, organizers can be sure that the cafés will be popular with young people in the area.",
                questions: [
                    { 
                        id: 21, options: { A: "aim", B: "idea", C: "plan", D: "view" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. idea", 
                            "Cụm 'The idea of...' (Ý tưởng về...). Ý tưởng về quán cà phê thanh niên là một ý tưởng đã phát triển gần đây.", 
                            "<li><b>A. aim:</b> mục đích (thường là để làm gì đó).</li><li><b>C. plan:</b> kế hoạch (cụ thể).</li><li><b>D. view:</b> quan điểm.</li>", 
                            "Collocation: <i>The idea of something</i>."
                        )
                    },
                    { 
                        id: 22, options: { A: "what", B: "where", C: "which", D: "who" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. where", 
                            "Dùng trạng từ quan hệ 'where' để thay thế cho danh từ chỉ nơi chốn 'places' (nơi mà).", 
                            "<li><b>A. what:</b> cái gì (không dùng trong mệnh đề quan hệ bổ nghĩa cho danh từ).</li><li><b>C. which:</b> cái mà (cần giới từ 'in which' mới đúng ngữ cảnh relax IN).</li><li><b>D. who:</b> người mà.</li>", 
                            "Grammar: <i>Relative Adverbs (where)</i>."
                        )
                    },
                    { 
                        id: 23, options: { A: "get", B: "have", C: "make", D: "take" }, correct: "D", 
                        explanation: formatExplanation(
                            "D. take", 
                            "Cụm động từ 'take part in' có nghĩa là tham gia.", 
                            "<li><b>A. get:</b> lấy.</li><li><b>B. have:</b> có.</li><li><b>C. make:</b> làm.</li>", 
                            "Phrase: <i>Take part in</i>."
                        )
                    },
                    { 
                        id: 24, options: { A: "attracted", B: "interested", C: "keen", D: "happy" }, correct: "C", 
                        explanation: formatExplanation(
                            "C. keen", 
                            "Cấu trúc 'keen on' (yêu thích/quan tâm đến).", 
                            "<li><b>A. attracted:</b> đi với 'to' (thu hút).</li><li><b>B. interested:</b> đi với 'in' (quan tâm).</li><li><b>D. happy:</b> đi với 'with/about' (vui vẻ).</li>", 
                            "Collocation: <i>Keen on</i>."
                        )
                    },
                    { 
                        id: 25, options: { A: "need", B: "ought", C: "should", D: "would" }, correct: "D", 
                        explanation: formatExplanation(
                            "D. would", 
                            "Dùng 'would' để chỉ nhóm người 'sẽ' (có ý định/sẵn lòng) tham gia. Ở đây 'would' diễn tả sự việc trong tương lai từ góc nhìn của kế hoạch.", 
                            "<li><b>A. need:</b> cần 'to' (need to).</li><li><b>B. ought:</b> cần 'to' (ought to).</li><li><b>C. should:</b> nên (ngụ ý khuyên bảo, không hợp ngữ cảnh mô tả thực tế bằng 'would').</li>", 
                            ""
                        )
                    },
                    { 
                        id: 26, options: { A: "course", B: "direction", C: "route", D: "way" }, correct: "D", 
                        explanation: formatExplanation(
                            "D. way", 
                            "Cụm từ 'In this way' (Theo cách này/Bằng cách này).", 
                            "<li><b>A. course:</b> khóa học/tiến trình.</li><li><b>B. direction:</b> hướng.</li><li><b>C. route:</b> lộ trình.</li>", 
                            "Phrase: <i>In this way</i>."
                        )
                    }
                ]
            },
            {
                id: "test5",
                title: "Healthy snacks on the run",
                text: "In today’s busy lives we often have little time for healthy eating, so we do the easy thing and eat snacks like crisps or sweets instead. <span id='gap-test5-21' class='gap-slot'>(21)............</span>, it’s possible to eat quickly and healthily. All you <span id='gap-test5-22' class='gap-slot'>(22)............</span> to do is to follow a few simple rules.<br><br>First of all, read what it <span id='gap-test5-23' class='gap-slot'>(23)............</span> on the packet before you buy a snack. This is important because people often think that they’re buying healthy snacks, but sugar may be the <span id='gap-test5-24' class='gap-slot'>(24)............</span> ingredient.<br><br>Try to look for healthier options – instead of eating ice cream, try frozen fruit juices, and most importantly, eat at <span id='gap-test5-25' class='gap-slot'>(25)............</span> times of the day. Learn when your body needs food so <span id='gap-test5-26' class='gap-slot'>(26)............</span> you don’t suddenly feel the need to eat a lot of unhealthy snack food.",
                questions: [
                    { 
                        id: 21, options: { A: "ago", B: "alike", C: "however", D: "whenever" }, correct: "C", 
                        explanation: formatExplanation(
                            "C. however", 
                            "Dùng 'However' (Tuy nhiên) để nối hai ý tương phản: cuộc sống bận rộn nhưng vẫn có thể ăn uống lành mạnh.", 
                            "<li><b>A. ago:</b> trước đây.</li><li><b>B. alike:</b> giống nhau.</li><li><b>D. whenever:</b> bất cứ khi nào.</li>", 
                            "Conjunctions: <i>However</i>."
                        )
                    },
                    { 
                        id: 22, options: { A: "can", B: "must", C: "need", D: "should" }, correct: "C", 
                        explanation: formatExplanation(
                            "C. need", 
                            "Cụm từ 'All you need to do' (Tất cả những gì bạn cần làm).", 
                            "<li><b>A. can:</b> có thể.</li><li><b>B. must:</b> phải.</li><li><b>D. should:</b> nên.</li>", 
                            "Phrase: <i>All you need to do</i>."
                        )
                    },
                    { 
                        id: 23, options: { A: "puts", B: "says", C: "talks", D: "writes" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. says", 
                            "Dùng 'it says' khi nói về thông tin ghi trên bao bì/văn bản.", 
                            "<li><b>A. puts:</b> đặt.</li><li><b>C. talks:</b> nói chuyện (người).</li><li><b>D. writes:</b> viết (hành động viết).</li>", 
                            "Collocation: <i>It says (on the label/sign)</i>."
                        )
                    },
                    { 
                        id: 24, options: { A: "big", B: "great", C: "large", D: "main" }, correct: "D", 
                        explanation: formatExplanation(
                            "D. main", 
                            "Thành phần chính (main ingredient).", 
                            "<li><b>A. big:</b> to.</li><li><b>B. great:</b> tuyệt vời.</li><li><b>C. large:</b> lớn.</li>", 
                            "Collocation: <i>Main ingredient</i>."
                        )
                    },
                    { 
                        id: 25, options: { A: "common", B: "equal", C: "even", D: "regular" }, correct: "D", 
                        explanation: formatExplanation(
                            "D. regular", 
                            "Ăn vào những giờ cố định/đều đặn (regular times).", 
                            "<li><b>A. common:</b> phổ biến.</li><li><b>B. equal:</b> công bằng.</li><li><b>C. even:</b> chẵn/ngay cả.</li>", 
                            "Collocation: <i>Regular times</i>."
                        )
                    },
                    { 
                        id: 26, options: { A: "that", B: "what", C: "when", D: "which" }, correct: "A", 
                        explanation: formatExplanation(
                            "A. that", 
                            "Cấu trúc 'so that' (để mà) chỉ mục đích.", 
                            "<li><b>B. what:</b> cái gì.</li><li><b>C. when:</b> khi nào.</li><li><b>D. which:</b> cái mà.</li>", 
                            "Structure: <i>So that</i>."
                        )
                    }
                ]
            },
            {
                id: "test6",
                title: "Stay Healthy by Walking",
                text: "Everybody worries about their general health and fitness. However, what many people don’t realize is that walking is one of the best ways to keep healthy.<br><br>This doesn’t mean that you <span id='gap-test6-21' class='gap-slot'>(21)............</span> to go on long walks in the countryside. You can walk home from work or school. You can walk to the shops. You can use the stairs <span id='gap-test6-22' class='gap-slot'>(22)............</span> of using the lift. You can even walk a dog <span id='gap-test6-23' class='gap-slot'>(23)............</span> you have one!<br><br>Now let’s look <span id='gap-test6-24' class='gap-slot'>(24)............</span> the benefits of walking. Firstly, it’s relaxing. Secondly, it improves your fitness and your health. <span id='gap-test6-25' class='gap-slot'>(25)............</span>, it’s a great way to socialize with your friends and family.<br><br>Remember, you don’t need <span id='gap-test6-26' class='gap-slot'>(26)............</span> expensive equipment for walking. You just need a good pair of walking boots or shoes.",
                questions: [
                    { 
                        id: 21, options: { A: "must", B: "have", C: "should", D: "might" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. have", 
                            "Cấu trúc 'have to' (phải). 'Doesn't mean you HAVE to go' (Không có nghĩa là bạn PHẢI đi).", 
                            "<li><b>A. must:</b> phải (nhưng không đi với 'to' và không dùng trợ động từ 'do' trong phủ định theo cách này).</li><li><b>C. should:</b> nên.</li><li><b>D. might:</b> có thể.</li>", 
                            "Grammar: <i>Have to</i>."
                        )
                    },
                    { 
                        id: 22, options: { A: "instead", B: "enough", C: "else", D: "well" }, correct: "A", 
                        explanation: formatExplanation(
                            "A. instead", 
                            "Cụm từ 'instead of' (thay vì).", 
                            "<li><b>B. enough:</b> đủ.</li><li><b>C. else:</b> khác.</li><li><b>D. well:</b> tốt.</li>", 
                            "Phrase: <i>Instead of</i>."
                        )
                    },
                    { 
                        id: 23, options: { A: "whether", B: "if", C: "as", D: "that" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. if", 
                            "Câu điều kiện: 'nếu' (if) bạn có một con chó.", 
                            "<li><b>A. whether:</b> liệu rằng (thường đi với or not).</li><li><b>C. as:</b> như/khi.</li><li><b>D. that:</b> rằng.</li>", 
                            "Grammar: <i>Conditionals (If)</i>."
                        )
                    },
                    { 
                        id: 24, options: { A: "on", B: "at", C: "for", D: "with" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. at", 
                            "Cụm động từ 'look at' (nhìn vào/xem xét).", 
                            "<li><b>A. on:</b> nhìn trên.</li><li><b>C. for:</b> tìm kiếm (look for).</li><li><b>D. with:</b> với.</li>", 
                            "Phrase: <i>Look at</i>."
                        )
                    },
                    { 
                        id: 25, options: { A: "Finally", B: "Conclusion", C: "End", D: "Last" }, correct: "A", 
                        explanation: formatExplanation(
                            "A. Finally", 
                            "Dùng để chốt lại một chuỗi liệt kê: Firstly... Secondly... Finally (Cuối cùng).", 
                            "<li><b>B. Conclusion:</b> Kết luận (In conclusion).</li><li><b>C. End:</b> Kết thúc (In the end).</li><li><b>D. Last:</b> Lần cuối (Last but not least).</li>", 
                            "Linkers: <i>Sequencing (Firstly, Secondly, Finally)</i>."
                        )
                    },
                    { 
                        id: 26, options: { A: "many", B: "any", C: "various", D: "some" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. any", 
                            "Dùng 'any' trong câu phủ định 'don't need any' (không cần bất kỳ).", 
                            "<li><b>A. many:</b> nhiều.</li><li><b>C. various:</b> đa dạng.</li><li><b>D. some:</b> một vài (thường dùng trong khẳng định).</li>", 
                            "Grammar: <i>Any in negative sentences</i>."
                        )
                    }
                ]
            }
        ];

        // --- Application Logic ---
        const app = {
            state: {
                currentTestIdx: 0,
                score: 0,
                userName: "Student",
                startTime: null,
                endTime: null,
                globalTimer: null,
                questionStates: {}, 
                penaltyActiveKey: null
            },

            init() {
                db.forEach(test => {
                    test.questions.forEach(q => {
                        this.state.questionStates[`${test.id}-${q.id}`] = { status: 'unanswered', attempts: 0, points: 0, selected: null };
                    });
                });
            },

            startExam() {
                const nameInput = document.getElementById('user-name-input').value.trim();
                if (!nameInput) {
                    alert("Please enter your name to start.");
                    return;
                }
                this.state.userName = nameInput;
                this.state.startTime = new Date();
                
                document.getElementById('header-name').textContent = this.state.userName;
                document.getElementById('screen-welcome').classList.add('hidden');
                document.getElementById('screen-app').classList.remove('hidden');
                document.getElementById('screen-app').classList.add('flex');

                this.startGlobalTimer();
                this.renderTest();
            },

            startGlobalTimer() {
                this.state.globalTimer = setInterval(() => {
                    const now = new Date();
                    const diff = now - this.state.startTime;
                    const date = new Date(diff);
                    const str = date.toISOString().substr(11, 8);
                    document.getElementById('timer-display').textContent = str;
                }, 1000);
            },

            renderTest(preserveScroll = false) {
                const test = db[this.state.currentTestIdx];
                
                // 1. Capture Scroll & Blur Focus
                const container = document.getElementById('questions-container');
                let scrollPos = 0;
                
                if (preserveScroll && container) {
                    scrollPos = container.scrollTop;
                    if (document.activeElement && document.activeElement.tagName === 'BUTTON') {
                        document.activeElement.blur();
                    }
                }

                document.getElementById('header-title').textContent = `${test.id.toUpperCase()}: ${test.title}`;
                document.getElementById('header-progress').textContent = `${this.state.currentTestIdx + 1}/${db.length}`;
                
                this.renderText(test);
                this.renderQuestions(test);

                const btnNext = document.getElementById('btn-next');
                if (this.state.currentTestIdx === db.length - 1) {
                    btnNext.innerHTML = `<i class="fas fa-flag-checkered text-rose-600"></i>`;
                    btnNext.onclick = () => this.finishExam();
                } else {
                    btnNext.innerHTML = `<i class="fas fa-chevron-right"></i>`;
                    btnNext.onclick = () => this.navTest(1);
                }
                document.getElementById('btn-prev').disabled = this.state.currentTestIdx === 0;

                // 2. Restore Scroll with RequestAnimationFrame (Microtask - Critical Fix)
                if (preserveScroll && container) {
                    requestAnimationFrame(() => {
                         container.scrollTop = scrollPos;
                    });
                }
            },

            renderText(test) {
                const contentDiv = document.getElementById('reading-text');
                contentDiv.innerHTML = test.text;

                test.questions.forEach(q => {
                    const key = `${test.id}-${q.id}`;
                    const state = this.state.questionStates[key];
                    const gapEl = document.getElementById(`gap-${key}`);
                    
                    if (gapEl) {
                        if (state.status === 'correct') {
                            gapEl.className = 'gap-slot filled-correct';
                            gapEl.textContent = q.options[q.correct];
                        } else if (state.status === 'wrong_final') {
                            gapEl.className = 'gap-slot filled-wrong';
                            gapEl.textContent = q.options[q.correct];
                        } else {
                            gapEl.className = 'gap-slot';
                        }
                    }
                });
            },

            renderQuestions(test) {
                const container = document.getElementById('questions-container');
                
                // Smart Render Logic
                const firstKey = `${test.id}-${test.questions[0].id}`;
                const firstCard = document.getElementById(`card-${firstKey}`);
                const isUpdate = !!firstCard;

                if (!isUpdate) {
                    container.innerHTML = '';
                }

                test.questions.forEach((q, idx) => {
                    const key = `${test.id}-${q.id}`;
                    const state = this.state.questionStates[key];
                    
                    // --- STYLE GENERATION ---
                    let cardClasses = "relative rounded-xl border-2 p-5 transition-all duration-300 ";
                    
                    let isLocked = false;
                    if (this.state.penaltyActiveKey && this.state.penaltyActiveKey !== key) {
                        isLocked = true;
                        cardClasses += "opacity-60 pointer-events-none "; // Dim and disable interactions
                    }

                    if (state.status === 'penalty') {
                        cardClasses += "bg-[#fffbf0] border-orange-300 shadow-md overflow-hidden";
                    } else if (state.status === 'correct') {
                        cardClasses += "bg-green-50 border-green-200";
                    } else if (state.status === 'wrong_final') {
                        cardClasses += "bg-red-50 border-red-200";
                    } else {
                        cardClasses += "bg-white border-transparent shadow-sm hover:shadow-md";
                    }

                    // --- CONTENT BUILDER ---
                    let cardContent = "";

                    // If locked, add overlay layer at the top of content
                    if (isLocked) {
                        cardContent += `
                            <div class="absolute inset-0 z-50 bg-white/20 flex items-center justify-center rounded-xl backdrop-blur-[1px]">
                                <div class="bg-white px-4 py-2 rounded-full shadow-lg border border-slate-200 text-sm font-bold text-slate-500 flex items-center gap-2">
                                    <i class="fas fa-lock"></i> Locked
                                </div>
                            </div>
                        `;
                    }

                    // 1. Progress Bar (Penalty only)
                    if (state.status === 'penalty') {
                        cardContent += `<div id="timer-bar-${key}" class="absolute top-0 left-0 h-1.5 bg-orange-500 transition-all duration-100 ease-linear z-10" style="width: 100%"></div>`;
                    }

                    // 2. Header
                    let headerStatus = "";
                    if (state.status === 'correct') headerStatus = `<span class="text-green-600 font-bold text-sm bg-white px-2 py-1 rounded shadow-sm"><i class="fas fa-check"></i> Correct!</span>`;
                    if (state.status === 'wrong_final') headerStatus = `<span class="text-red-600 font-bold text-sm bg-white px-2 py-1 rounded shadow-sm"><i class="fas fa-times"></i> Failed</span>`;
                    if (state.status === 'penalty') headerStatus = `<span class="text-orange-600 font-bold text-sm flex items-center gap-2"><i class="fas fa-circle-notch fa-spin"></i> Think again...</span>`;

                    cardContent += `
                        <div class="flex justify-between items-center mb-4 mt-2">
                            <div class="flex items-center gap-3">
                                <span class="w-8 h-8 rounded-full bg-slate-800 text-white font-bold flex items-center justify-center text-sm shadow-md">${q.id}</span>
                                <span class="text-xs text-slate-400 font-bold uppercase tracking-wide">Select Answer</span>
                            </div>
                            ${headerStatus}
                        </div>
                    `;

                    // 3. Options Grid
                    cardContent += `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-2">`;
                    for (const [optKey, optVal] of Object.entries(q.options)) {
                        let btnClass = `group relative w-full text-left px-4 py-3 rounded-xl border text-sm font-bold transition-all duration-200 flex items-center gap-3 `;
                        let labelClass = "w-6 h-6 rounded flex items-center justify-center text-xs font-bold ";
                        let iconHtml = "";
                        let isDisabled = "";
                        let clickHandler = `onclick="app.handleAnswer('${test.id}', ${q.id}, '${optKey}')"`;

                        // When locked, we don't strictly need to disable buttons in HTML because parent has pointer-events-none,
                        // but it's good practice.
                        if (isLocked) isDisabled = "disabled";

                        if (state.status === 'unanswered') {
                            btnClass += "bg-white border-slate-200 text-slate-600 hover:border-rose-400 hover:bg-rose-50 hover:text-rose-700 shadow-sm";
                            labelClass += "bg-slate-100 text-slate-500 group-hover:bg-rose-200 group-hover:text-rose-700";
                        } 
                        else if (state.status === 'penalty') {
                            isDisabled = "disabled";
                            clickHandler = "";
                            if (optKey === state.selected) {
                                btnClass += "bg-red-50 border-red-100 text-red-400 opacity-100 cursor-not-allowed";
                                iconHtml = `<i class="fas fa-times absolute right-3 text-red-400"></i>`;
                                labelClass += "bg-red-100 text-red-400";
                            } else {
                                btnClass += "bg-white border-slate-100 text-slate-300 opacity-60 cursor-not-allowed";
                                labelClass += "bg-slate-100 text-slate-300";
                            }
                        }
                        else if (state.status === 'correct') {
                            isDisabled = "disabled";
                            clickHandler = "";
                            if (optKey === q.correct) {
                                btnClass += "bg-green-600 border-green-600 text-white shadow-md transform scale-[1.02]";
                                iconHtml = `<i class="fas fa-check absolute right-3 text-white"></i>`;
                                labelClass += "bg-white/20 text-white"; 
                            } else {
                                btnClass += "bg-white border-slate-100 text-slate-300 opacity-50";
                                labelClass += "bg-slate-100 text-slate-500";
                            }
                        }
                        else if (state.status === 'wrong_final') {
                            isDisabled = "disabled";
                            clickHandler = "";
                            if (optKey === q.correct) {
                                btnClass += "bg-green-100 border-green-300 text-green-700"; 
                                iconHtml = `<i class="fas fa-check absolute right-3 text-green-500"></i>`;
                                labelClass += "bg-green-200 text-green-700";
                            } else if (optKey === state.selected) {
                                btnClass += "bg-red-500 border-red-600 text-white"; 
                                labelClass += "bg-white/20 text-white";
                            } else {
                                btnClass += "bg-white border-slate-100 text-slate-300 opacity-50";
                                labelClass += "bg-slate-100 text-slate-500";
                            }
                        }

                        cardContent += `
                            <button ${isDisabled} class="${btnClass}" ${clickHandler}>
                                <span class="${labelClass}">${optKey}</span> 
                                ${optVal}
                                ${iconHtml}
                            </button>
                        `;
                    }
                    cardContent += `</div>`;

                    // 4. Explanation
                    if (state.status === 'correct' || state.status === 'wrong_final') {
                        const expClass = state.status === 'correct' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                        const headerClass = state.status === 'correct' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                        const headerText = state.status === 'correct' ? '<i class="fas fa-lightbulb"></i> Detailed Explanation' : '<i class="fas fa-exclamation-circle"></i> Correction';
                        
                        cardContent += `
                            <div class="mt-4 rounded-xl border overflow-hidden ${expClass}">
                                <div class="px-4 py-2 font-bold text-xs uppercase tracking-wider flex items-center gap-2 ${headerClass}">
                                    ${headerText}
                                </div>
                                <div class="p-4 text-sm leading-relaxed text-slate-700">
                                    ${q.explanation}
                                </div>
                            </div>
                        `;
                    }

                    // --- DOM MANIPULATION ---
                    let card;
                    if (isUpdate) {
                        card = document.getElementById(`card-${key}`);
                        if (card) {
                            card.className = cardClasses;
                            card.innerHTML = cardContent;
                        }
                    } else {
                        card = document.createElement('div');
                        card.id = `card-${key}`;
                        card.className = cardClasses;
                        card.innerHTML = cardContent;
                        container.appendChild(card);
                    }
                });
            },

            handleAnswer(testId, qId, selectedOpt) {
                if (this.state.penaltyActiveKey) return; 

                const test = db[this.state.currentTestIdx];
                const q = test.questions.find(item => item.id === qId);
                const key = `${testId}-${qId}`;
                const state = this.state.questionStates[key];

                state.selected = selectedOpt; 

                if (selectedOpt === q.correct) {
                    playSound('correct');
                    state.status = 'correct';
                    state.points = state.attempts === 0 ? 1 : 0.5;
                    this.state.score += state.points;
                } else {
                    playSound('wrong');
                    state.attempts++;
                    if (state.attempts === 1) {
                        state.status = 'penalty';
                        this.state.penaltyActiveKey = key; 
                        this.startPenaltyTimer(key);
                    } else {
                        state.status = 'wrong_final';
                        state.points = 0;
                    }
                }

                this.renderTest(true); 
            },

            startPenaltyTimer(key) {
                let timeLeft = 100; // 10s
                const interval = setInterval(() => {
                    timeLeft--;
                    const bar = document.getElementById(`timer-bar-${key}`);
                    if (bar) bar.style.width = `${timeLeft}%`;

                    if (timeLeft <= 0) {
                        clearInterval(interval);
                        const state = this.state.questionStates[key];
                        state.status = 'unanswered'; 
                        state.selected = null; 
                        this.state.penaltyActiveKey = null; 
                        this.renderTest(true); 
                    }
                }, 100); 
            },

            navTest(direction) {
                if (this.state.penaltyActiveKey) return; 
                this.state.currentTestIdx += direction;
                
                // Explicitly reset scroll for new test
                const textContainer = document.getElementById('reading-text').parentElement;
                const qContainer = document.getElementById('questions-container');
                if (textContainer) textContainer.scrollTop = 0;
                if (qContainer) qContainer.scrollTop = 0;
                
                this.renderTest(false);
            },

            finishExam() {
                clearInterval(this.state.globalTimer);
                this.state.endTime = new Date();

                const totalQ = 18; // 3 tests * 6 questions
                const score = this.state.score;
                const percent = Math.round((score / totalQ) * 100);
                const diffMs = this.state.endTime - this.state.startTime;
                
                const minutes = Math.floor(diffMs / 60000);
                const seconds = Math.floor(((diffMs % 60000) / 1000));
                const durationStr = `${minutes} min ${seconds} sec`;

                document.getElementById('screen-app').classList.add('hidden');
                document.getElementById('screen-result').classList.remove('hidden');

                document.getElementById('result-candidate').textContent = this.state.userName;
                document.getElementById('result-score').textContent = score;
                document.getElementById('result-percent').textContent = `${percent}%`;
                document.getElementById('result-duration').textContent = durationStr;

                // Status Message
                const statusMsg = document.getElementById('result-status-msg');
                if (percent >= 85) {
                    statusMsg.innerHTML = `<i class="fas fa-check-circle text-green-500"></i> <span class="text-green-600">Passed! You have mastered this set.</span>`;
                } else {
                    statusMsg.innerHTML = `<i class="fas fa-exclamation-triangle text-orange-500"></i> <span class="text-orange-600">Not Passed. You need 85% to master this set.</span>`;
                }

                // Render List
                const listContainer = document.getElementById('result-list');
                listContainer.innerHTML = '';

                // Calculate score per test
                db.forEach((test, idx) => {
                    let correctCount = 0;
                    test.questions.forEach(q => {
                        const s = this.state.questionStates[`${test.id}-${q.id}`];
                        if (s.status === 'correct') correctCount++; // Simplified counting
                    });

                    const item = document.createElement('div');
                    item.className = "bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm";
                    item.innerHTML = `
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">TEST ${idx + 4}</p>
                            <h4 class="font-bold text-slate-800">${test.title}</h4>
                        </div>
                        <span class="font-bold text-slate-600 text-lg">${correctCount}/6 correct</span>
                    `;
                    listContainer.appendChild(item);
                });
            }
        };

        app.init();

    </script>
</body>
</html>