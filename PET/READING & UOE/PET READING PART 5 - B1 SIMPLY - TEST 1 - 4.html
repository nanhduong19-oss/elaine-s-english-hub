<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PET Reading Part 5 - Mastery Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Sử dụng Plus Jakarta Sans thay cho Google Sans để đảm bảo hiển thị đẹp trên mọi thiết bị */
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Gap Styles inside Text */
        .gap-slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 24px;
            padding: 0 6px;
            margin: 0 2px;
            border-radius: 4px;
            background-color: #f1f5f9;
            color: #64748b;
            font-weight: 700;
            font-size: 0.9em;
            border: 1px solid #e2e8f0;
            cursor: default;
            transition: all 0.2s;
        }
        .gap-slot.filled-correct { background-color: #dcfce7; color: #15803d; border-color: #86efac; }
        .gap-slot.filled-wrong { background-color: #fee2e2; color: #b91c1c; border-color: #fca5a5; }
        .gap-slot.example { background-color: #dcfce7; color: #15803d; border-color: #86efac; font-weight: 800; }

        /* Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

        .progress-bar-transition { transition: width 0.1s linear; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col text-slate-800 overflow-hidden">

    <!-- SCREEN 1: WELCOME (ROSE THEME) -->
    <div id="screen-welcome" class="fixed inset-0 z-50 bg-slate-50 flex items-center justify-center p-4">
        <div class="bg-white max-w-md w-full rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
            <!-- Top bar Rose -->
            <div class="h-2 bg-rose-500 w-full"></div>
            <div class="p-8 text-center">
                <h1 class="text-3xl font-extrabold text-slate-800 mb-2">PET Reading Part 5</h1>
                <p class="text-slate-500 mb-6 font-medium">SET 1 (Tests 1 - 4)</p>
                
                <div class="inline-block bg-orange-100 text-orange-700 px-4 py-1 rounded-full text-xs font-bold tracking-wider mb-8">
                    MASTERY STUDY MODE
                </div>

                <div class="text-left mb-6">
                    <label class="block text-sm font-bold text-slate-700 mb-2 ml-1">Your Name</label>
                    <input type="text" id="user-name-input" placeholder="Enter your name..." 
                        class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-rose-500 focus:border-rose-500 outline-none transition-all text-slate-800 font-medium"
                        onkeypress="if(event.key === 'Enter') app.startExam()">
                </div>

                <!-- Start Button Rose -->
                <button onclick="app.startExam()" class="w-full bg-rose-600 hover:bg-rose-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-rose-200 transition-transform active:scale-[0.98]">
                    Start Practice
                </button>
            </div>
            
            <div class="bg-slate-50 p-6 border-t border-slate-100">
                <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase flex items-center gap-2">
                    <i class="fas fa-info-circle text-slate-400"></i> Mastery Rules
                </h3>
                <ul class="space-y-3 text-sm font-medium">
                    <li class="flex items-start gap-3">
                        <i class="fas fa-check text-green-500 mt-0.5"></i>
                        <span class="text-slate-600"><strong class="text-green-700">1st Try Correct:</strong> Full points (100%).</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i class="fas fa-exclamation-triangle text-orange-500 mt-0.5"></i>
                        <span class="text-slate-600"><strong class="text-orange-600">1st Try Wrong:</strong> 10s Penalty Wait + Global Lock. Score reduced to 50%.</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i class="fas fa-times text-red-500 mt-0.5"></i>
                        <span class="text-slate-600"><strong class="text-red-600">2nd Try Wrong:</strong> 0 points. Answer revealed.</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <!-- Target Star Rose -->
                        <i class="fas fa-star text-rose-500 mt-0.5"></i>
                        <span class="text-slate-600"><strong class="text-rose-700">Target:</strong> You need 85% score to pass.</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- SCREEN 2: MAIN APP (Hidden by default) -->
    <div id="screen-app" class="hidden flex-col h-full">
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 h-16 flex-none z-20">
            <div class="h-full max-w-[1920px] mx-auto px-6 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <!-- Timer Rose Theme -->
                    <div class="px-3 py-1 bg-rose-50 border border-rose-200 rounded-lg text-rose-700 font-mono font-bold text-sm flex items-center gap-2">
                        <i class="far fa-clock"></i> <span id="timer-display">00:00:00</span>
                    </div>
                    <h2 id="header-title" class="font-bold text-slate-800 text-lg truncate">Test 1</h2>
                </div>

                <div class="flex items-center gap-6">
                     <div class="text-right hidden md:block">
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Candidate</p>
                        <p id="header-name" class="font-bold text-slate-700 text-sm">Student</p>
                    </div>
                    <div class="h-8 w-px bg-slate-200 hidden md:block"></div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mr-1">Progress</span>
                        <span id="header-progress" class="font-bold text-xl text-slate-800">1/4</span>
                    </div>
                    <div class="flex gap-2">
                        <!-- Nav Buttons Hover Rose -->
                        <button onclick="app.navTest(-1)" id="btn-prev" class="w-9 h-9 rounded-full border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-50 hover:text-rose-600 disabled:opacity-30 transition-colors">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button onclick="app.navTest(1)" id="btn-next" class="w-9 h-9 rounded-full border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-50 hover:text-rose-600 transition-colors">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex overflow-hidden bg-slate-100">
            <div class="max-w-[1600px] w-full mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
                
                <!-- LEFT: TEXT -->
                <div class="lg:col-span-6 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
                    <div class="p-8 overflow-y-auto custom-scrollbar flex-grow">
                        <div id="reading-text" class="text-lg leading-8 text-slate-700 text-justify font-normal">
                            <!-- Text injected here -->
                        </div>
                    </div>
                </div>

                <!-- RIGHT: QUESTIONS -->
                <div class="lg:col-span-6 flex flex-col h-full overflow-hidden">
                    <div class="bg-white rounded-t-2xl border-b border-slate-100 p-4 flex justify-between items-center bg-white shadow-sm z-10">
                        <!-- Header Rose -->
                        <h3 class="font-bold text-rose-600 flex items-center gap-2">
                            <i class="far fa-file-alt"></i> QUESTIONS
                        </h3>
                        <span class="text-[10px] font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded border border-orange-100 tracking-wider">STUDY MODE</span>
                    </div>
                    
                    <div id="questions-container" class="flex-grow overflow-y-auto custom-scrollbar bg-slate-50/50 p-4 space-y-4">
                        <!-- Questions injected here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SCREEN 3: RESULT (Updated Layout) -->
    <div id="screen-result" class="hidden fixed inset-0 z-50 bg-slate-50 overflow-y-auto custom-scrollbar">
        <div class="min-h-screen w-full flex items-start justify-center p-6 md:py-12">
            <div class="max-w-3xl w-full flex flex-col gap-6">
                
                <!-- Title -->
                <div class="text-center mb-2">
                    <h1 class="text-4xl font-extrabold text-slate-800">Study Mode Results</h1>
                    <div id="result-status-msg" class="flex items-center justify-center gap-2 mt-3 font-bold text-lg">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Top Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Candidate Card Rose Theme -->
                    <div class="bg-rose-50/50 border border-rose-100 rounded-2xl p-6 flex flex-col justify-between h-32 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-rose-500"></div>
                        <p class="text-xs font-bold text-rose-500 uppercase tracking-wider">Candidate</p>
                        <p id="result-candidate" class="text-2xl font-bold text-slate-800 truncate">Student Name</p>
                    </div>

                    <!-- Score Card (Red/Orange usually indicates score in this design system, sticking to Red for contrast) -->
                    <div class="bg-red-50/50 border border-red-100 rounded-2xl p-6 flex flex-col justify-center h-32 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-red-400"></div>
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-xs font-bold text-red-500 uppercase tracking-wider mb-1">Mastery Score</p>
                                <div class="flex items-baseline gap-1">
                                    <span id="result-score" class="text-4xl font-extrabold text-slate-800">0</span>
                                    <span class="text-slate-400 font-medium text-lg">/ 24</span>
                                </div>
                            </div>
                            <div class="bg-white px-3 py-1 rounded-lg border border-red-100 shadow-sm">
                                <span id="result-percent" class="text-lg font-extrabold text-red-600">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Retry Button Rose/Red -->
                <button onclick="location.reload()" class="w-full bg-rose-600 hover:bg-rose-700 text-white text-lg font-bold py-4 rounded-xl shadow-lg shadow-rose-200 transition-all active:scale-[0.99] flex items-center justify-center gap-2">
                    <i class="fas fa-redo-alt"></i> Retry This Set
                </button>

                <!-- Stats Container -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-2">
                        <i class="far fa-clock text-slate-400"></i>
                        <h3 class="font-bold text-slate-700 text-sm">Performance Stats</h3>
                    </div>
                    <div class="p-6 flex justify-between items-center">
                        <span class="text-slate-500 font-medium">Duration:</span>
                        <span id="result-duration" class="font-bold text-slate-800">00 min 00 sec</span>
                    </div>
                </div>

                <!-- Detailed Breakdown -->
                <div id="result-list" class="space-y-3">
                    <!-- List items injected via JS -->
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- Sound Effects System ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration, vol = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }
        function playSound(type) {
            if (type === 'correct') { playTone(600, 'sine', 0.1); setTimeout(() => playTone(900, 'sine', 0.15), 100); }
            else if (type === 'wrong') { playTone(200, 'sawtooth', 0.2, 0.2); }
        }

        // --- Standardized Explanation Template ---
        const formatExplanation = (correct, whyCorrect, whyWrong, note) => {
            return `
                <div class="space-y-3">
                    <div class="flex gap-2 text-sm">
                        <span class="font-bold text-green-700 shrink-0">Đáp án đúng:</span>
                        <span class="text-slate-700">${correct} - ${whyCorrect}</span>
                    </div>
                    <div class="text-sm">
                        <span class="font-bold text-red-600 block mb-1">Tại sao các đáp án khác sai:</span>
                        <ul class="list-disc pl-5 text-slate-600 space-y-1">${whyWrong}</ul>
                    </div>
                    ${note ? `<div class="text-sm bg-blue-50 p-2 rounded border border-blue-100 text-slate-700"><span class="font-bold text-blue-700">Ghi nhớ:</span> ${note}</div>` : ''}
                </div>
            `;
        };

        // --- Data ---
        const db = [
            {
                id: "test1",
                title: "Holidays in Tanzania",
                text: "<p class='mb-4 text-slate-500 italic text-sm border-l-4 border-green-400 pl-3 py-1 bg-green-50'><strong>Example:</strong> The best way to travel is by <span class='gap-slot example'>(0) PLANE</span>.</p>Those who want special holidays away from the <span id='gap-test1-21' class='gap-slot'>(21)............</span>, while staying in truly luxurious safari accommodation, why not combine the exclusive and less-visited national parks of Ruaha and Selous? Then, add Zanzibar island to <span id='gap-test1-22' class='gap-slot'>(22)............</span> the perfect beach and wildlife experience.<br><br><span id='gap-test1-23' class='gap-slot'>(23)............</span> in the southern part of Tanzania, Ruaha and Selous national parks are in less known areas but provide a unique safari experience <span id='gap-test1-24' class='gap-slot'>(24)............</span> with the northern part of the country, where the usual tourist <span id='gap-test1-25' class='gap-slot'>(25)............</span>. Unlike the north, the south has a variety of animals to see throughout the year, with boat trips on many lakes and rivers being a wonderful way to see elephants, hippos and crocodiles up close. After the safari, you can jump on a plane and in a few hours find yourself <span id='gap-test1-26' class='gap-slot'>(26)............</span> one of the best beaches in the world.",
                questions: [
                    { 
                        id: 21, options: { A: "audiences", B: "crew", C: "crowds", D: "pedestrians" }, correct: "C", 
                        explanation: formatExplanation(
                            "C. crowds", 
                            "Cụm từ 'away from the crowds' có nghĩa là tránh xa đám đông, tìm nơi yên tĩnh.",
                            "<li><b>A. audiences:</b> khán giả (xem biểu diễn, nghe nhạc).</li><li><b>B. crew:</b> phi hành đoàn hoặc thủy thủ đoàn.</li><li><b>D. pedestrians:</b> người đi bộ trên đường.</li>",
                            "Idiom: <i>Far from the madding crowd</i> (xa lánh chốn lao xao)."
                        )
                    },
                    { 
                        id: 22, options: { A: "suggest", B: "create", C: "support", D: "involve" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. create", 
                            "Ngữ cảnh là kết hợp safari và đảo Zanzibar để 'tạo nên' một trải nghiệm hoàn hảo.",
                            "<li><b>A. suggest:</b> gợi ý.</li><li><b>C. support:</b> ủng hộ/hỗ trợ.</li><li><b>D. involve:</b> liên quan/bao gồm.</li>",
                            "Collocation: <i>Create an experience</i>."
                        )
                    },
                    { 
                        id: 23, options: { A: "Located", B: "Invented", C: "Settled", D: "Seated" }, correct: "A", 
                        explanation: formatExplanation(
                            "A. Located", 
                            "Dùng để chỉ vị trí địa lý: 'Located in the southern part...' (Nằm ở phía nam...).",
                            "<li><b>B. Invented:</b> được phát minh.</li><li><b>C. Settled:</b> định cư hoặc giải quyết (vấn đề).</li><li><b>D. Seated:</b> có chỗ ngồi.</li>",
                            "Phrase: <i>Located in/at/on</i>."
                        )
                    },
                    { 
                        id: 24, options: { A: "added", B: "compared", C: "invited", D: "applied" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. compared", 
                            "Cấu trúc 'Compared with...' (Được so sánh với...). Câu đang so sánh trải nghiệm ở phía Nam với phía Bắc.",
                            "<li><b>A. added:</b> thêm vào.</li><li><b>C. invited:</b> mời.</li><li><b>D. applied:</b> áp dụng.</li>",
                            "Grammar: <i>Compared to/with</i>."
                        )
                    },
                    { 
                        id: 25, options: { A: "city", B: "package", C: "neighbourhood", D: "destination" }, correct: "D", 
                        explanation: formatExplanation(
                            "D. destination", 
                            "Cụm từ 'tourist destination' nghĩa là điểm đến du lịch.",
                            "<li><b>A. city:</b> thành phố.</li><li><b>B. package:</b> gói (ví dụ: holiday package).</li><li><b>C. neighbourhood:</b> khu vực lân cận/hàng xóm.</li>",
                            "Collocation: <i>Popular tourist destination</i>."
                        )
                    },
                    { 
                        id: 26, options: { A: "examining", B: "researching", C: "exploring", D: "inventing" }, correct: "C", 
                        explanation: formatExplanation(
                            "C. exploring", 
                            "Thấy bản thân đang 'khám phá' (exploring) một trong những bãi biển đẹp nhất.",
                            "<li><b>A. examining:</b> kiểm tra (sức khỏe, chi tiết).</li><li><b>B. researching:</b> nghiên cứu (học thuật).</li><li><b>D. inventing:</b> phát minh.</li>",
                            "Verb pattern: <i>Find yourself doing something</i>."
                        )
                    }
                ]
            },
            {
                id: "test2",
                title: "My First Flight",
                text: "<p class='mb-4 text-slate-500 italic text-sm border-l-4 border-green-400 pl-3 py-1 bg-green-50'><strong>Example:</strong> The best way to travel is by <span class='gap-slot example'>(0) PLANE</span>.</p>Last week my family and I travelled by plane for the first time. I must admit we all had a few questions that we were too <span id='gap-test2-21' class='gap-slot'>(21)............</span> to ask anyone and I guess there are many other teens that could use some <span id='gap-test2-22' class='gap-slot'>(22)............</span> to help them go through their first flight.<br><br>So, first, make sure you arrive with all the <span id='gap-test2-23' class='gap-slot'>(23)............</span> paperwork to board the flight: that is your passport, which must be valid. As most airlines issue e-tickets, don't worry if you don't get a paper ticket, as well. Once you show though your e-ticket to the staff, you will be given a physical boarding pass; this is what will give you <span id='gap-test2-24' class='gap-slot'>(24)............</span> to the aeroplane.<br><br>All travellers get confused by airline rules about baggage. For trips lasting several days or more, you'll need to <span id='gap-test2-25' class='gap-slot'>(25)............</span> in a piece of hold luggage, while for a long weekend or for a city break, all you need can usually fit into a bag or case which you can take with you on the plane.<br><br>Once you've made it successfully on to your flight, look for a number followed by a letter on your boarding pass. That's your seat number. If you can't locate your seat, the cabin crew will be happy to help and put your luggage in a safe place, either in an overhead <span id='gap-test2-26' class='gap-slot'>(26)............</span> or under your seat.",
                questions: [
                    { id: 21, options: { A: "confused", B: "embarrassed", C: "interested", D: "relieved" }, correct: "B", 
                      explanation: formatExplanation("B. embarrassed", "Quá 'ngại/xấu hổ' để hỏi.", "<li><b>A. confused:</b> bối rối.</li><li><b>C. interested:</b> quan tâm.</li><li><b>D. relieved:</b> nhẹ nhõm.</li>", "Structure: <i>too [adj] to [verb]</i>") },
                    { id: 22, options: { A: "clues", B: "news", C: "tips", D: "predictions" }, correct: "C", 
                      explanation: formatExplanation("C. tips", "Cần một vài 'mẹo' (tips) để giúp họ.", "<li><b>A. clues:</b> manh mối.</li><li><b>B. news:</b> tin tức.</li><li><b>D. predictions:</b> dự đoán.</li>", "Collocation: <i>Practical tips</i>") },
                    { id: 23, options: { A: "necessary", B: "common", C: "convenient", D: "frequent" }, correct: "A", 
                      explanation: formatExplanation("A. necessary", "Giấy tờ 'cần thiết' (necessary paperwork).", "<li><b>B. common:</b> phổ biến.</li><li><b>C. convenient:</b> tiện lợi.</li><li><b>D. frequent:</b> thường xuyên.</li>", "") },
                    { id: 24, options: { A: "introduction", B: "connection", C: "allowance", D: "access" }, correct: "D", 
                      explanation: formatExplanation("D. access", "Cụm 'Give access to': Cho quyền đi vào/truy cập.", "<li><b>A. introduction:</b> sự giới thiệu.</li><li><b>B. connection:</b> sự kết nối.</li><li><b>C. allowance:</b> sự cho phép/tiền tiêu vặt.</li>", "Collocation: <i>Gain/Have access to</i>") },
                    { id: 25, options: { A: "call", B: "fill", C: "check", D: "give" }, correct: "C", 
                      explanation: formatExplanation("C. check", "Cụm 'Check in luggage': Ký gửi hành lý.", "<li><b>A. call:</b> gọi.</li><li><b>B. fill:</b> điền.</li><li><b>D. give:</b> đưa.</li>", "Phrasal verb: <i>Check in</i>") },
                    { id: 26, options: { A: "drawer", B: "locker", C: "case", D: "shelf" }, correct: "B", 
                      explanation: formatExplanation("B. locker", "Khoang hành lý trên đầu gọi là 'overhead locker'.", "<li><b>A. drawer:</b> ngăn kéo.</li><li><b>C. case:</b> vali/hộp.</li><li><b>D. shelf:</b> cái kệ.</li>", "") }
                ]
            },
            {
                id: "test3",
                title: "Technology in the Home",
                text: "<p class='mb-4 text-slate-500 italic text-sm border-l-4 border-green-400 pl-3 py-1 bg-green-50'><strong>Example:</strong> The best way to travel is by <span class='gap-slot example'>(0) PLANE</span>.</p>There have been so many <span id='gap-test3-21' class='gap-slot'>(21)............</span> over the last twenty years or so that have had a(n) <span id='gap-test3-22' class='gap-slot'>(22)............</span> effect on our life. Take, smartphones, as an example. In fact, you could say that our lives have totally changed due to the internet and all the technology that has <span id='gap-test3-23' class='gap-slot'>(23)............</span> because of it. When you stop to think about it, how many hours a week do you sit at your computer, typing on your keyboard? I think you would be <span id='gap-test3-24' class='gap-slot'>(24)............</span> at the amount of time you spend using technology in the home.<br><br>People of all ages are beginning to <span id='gap-test3-25' class='gap-slot'>(25)............</span> on the internet for many different things and it is more than likely that you are spending two to three whole days a week doing some kind of activity online. Maybe it's time to turn off the computer and have a nice, face-to-face <span id='gap-test3-26' class='gap-slot'>(26)............</span> with your friends, family or colleagues.",
                questions: [
                    { id: 21, options: { A: "discoveries", B: "equipment", C: "inventions", D: "designs" }, correct: "C", explanation: formatExplanation("C. inventions", "Các 'phát minh' mới (inventions) như smartphone.", "<li><b>A. discoveries:</b> khám phá (những gì đã tồn tại).</li><li><b>B. equipment:</b> thiết bị (không đếm được).</li><li><b>D. designs:</b> thiết kế.</li>", "") },
                    { id: 22, options: { A: "enormous", B: "common", C: "essential", D: "limited" }, correct: "A", explanation: formatExplanation("A. enormous", "Tác động 'to lớn' (enormous effect).", "<li><b>B. common:</b> phổ biến.</li><li><b>C. essential:</b> thiết yếu.</li><li><b>D. limited:</b> hạn chế.</li>", "") },
                    { id: 23, options: { A: "produced", B: "appeared", C: "presented", D: "installed" }, correct: "B", explanation: formatExplanation("B. appeared", "Công nghệ đã 'xuất hiện' (appeared).", "<li><b>A. produced:</b> được sản xuất.</li><li><b>C. presented:</b> được trình bày.</li><li><b>D. installed:</b> được cài đặt.</li>", "") },
                    { id: 24, options: { A: "shocked", B: "confused", C: "frightened", D: "angry" }, correct: "A", explanation: formatExplanation("A. shocked", "Bạn sẽ bị 'sốc' (shocked) với lượng thời gian bỏ ra.", "<li><b>B. confused:</b> bối rối.</li><li><b>C. frightened:</b> sợ hãi.</li><li><b>D. angry:</b> tức giận.</li>", "") },
                    { id: 25, options: { A: "base", B: "carry", C: "keep", D: "depend" }, correct: "D", explanation: formatExplanation("D. depend", "Cụm 'Depend on': Phụ thuộc vào.", "<li><b>A. base:</b> dựa vào (thường dùng bị động 'based on').</li><li><b>B. carry:</b> mang.</li><li><b>C. keep:</b> giữ.</li>", "") },
                    { id: 26, options: { A: "lecture", B: "conference", C: "discussion", D: "interview" }, correct: "C", explanation: formatExplanation("C. discussion", "Cuộc 'trò chuyện/thảo luận' (discussion).", "<li><b>A. lecture:</b> bài giảng.</li><li><b>B. conference:</b> hội nghị.</li><li><b>D. interview:</b> phỏng vấn.</li>", "") }
                ]
            },
            {
                id: "test4",
                title: "The Changing Internet",
                text: "<p class='mb-4 text-slate-500 italic text-sm border-l-4 border-green-400 pl-3 py-1 bg-green-50'><strong>Example:</strong> The best way to travel is by <span class='gap-slot example'>(0) PLANE</span>.</p>The internet may have started in the 1960s, but it wasn't until the 1990s when it became <span id='gap-test4-21' class='gap-slot'>(21)............</span> to the public. In 1994, the Stanford Federal Credit Union was the first bank in the world to <span id='gap-test4-22' class='gap-slot'>(22)............</span> online internet banking.<br><br>By 1995, people around the world were starting to have internet in their homes. Internet in those days was very slow because they had to use a dial-up <span id='gap-test4-23' class='gap-slot'>(23)............</span>. The computer needed to use a telephone line and sent noisy <span id='gap-test4-24' class='gap-slot'>(24)............</span> like a fax machine does. One of the problems was that if you were using the internet, you couldn't make or <span id='gap-test4-25' class='gap-slot'>(25)............</span> phone calls.<br><br>Over the years, the internet became faster and faster as there was no need to use the telephone line for the internet. Today, the Internet is more complex than ever. It <span id='gap-test4-26' class='gap-slot'>(26)............</span> computers, satellites, mobile devices and other gadgets in a network millions of times bigger than the original one.",
                questions: [
                    { id: 21, options: { A: "effective", B: "accurate", C: "available", D: "realistic" }, correct: "C", explanation: formatExplanation("C. available", "Có sẵn cho công chúng (available to the public).", "<li><b>A. effective:</b> hiệu quả.</li><li><b>B. accurate:</b> chính xác.</li><li><b>D. realistic:</b> thực tế.</li>", "") },
                    { id: 22, options: { A: "allow", B: "afford", C: "deliver", D: "offer" }, correct: "D", explanation: formatExplanation("D. offer", "'Cung cấp' dịch vụ (offer service).", "<li><b>A. allow:</b> cho phép.</li><li><b>B. afford:</b> đủ tiền mua.</li><li><b>C. deliver:</b> giao hàng.</li>", "") },
                    { id: 23, options: { A: "connection", B: "contact", C: "mobile", D: "link" }, correct: "A", explanation: formatExplanation("A. connection", "'Dial-up connection': Kết nối quay số.", "<li><b>B. contact:</b> liên lạc.</li><li><b>C. mobile:</b> di động.</li><li><b>D. link:</b> đường dẫn.</li>", "") },
                    { id: 24, options: { A: "signs", B: "signals", C: "alarms", D: "rings" }, correct: "B", explanation: formatExplanation("B. signals", "Gửi 'tín hiệu' (signals).", "<li><b>A. signs:</b> biển báo.</li><li><b>C. alarms:</b> báo động.</li><li><b>D. rings:</b> tiếng chuông.</li>", "") },
                    { id: 25, options: { A: "finish", B: "welcome", C: "receive", D: "buy" }, correct: "C", explanation: formatExplanation("C. receive", "Nhận cuộc gọi (receive phone calls).", "<li><b>A. finish:</b> kết thúc.</li><li><b>B. welcome:</b> chào đón.</li><li><b>D. buy:</b> mua.</li>", "") },
                    { id: 26, options: { A: "creates", B: "adds", C: "separates", D: "connects" }, correct: "D", explanation: formatExplanation("D. connects", "'Kết nối' các máy tính (connects computers).", "<li><b>A. creates:</b> tạo ra.</li><li><b>B. adds:</b> thêm.</li><li><b>C. separates:</b> tách biệt.</li>", "") }
                ]
            }
        ];

        // --- Application Logic ---
        const app = {
            state: {
                currentTestIdx: 0,
                score: 0,
                userName: "Student",
                startTime: null,
                endTime: null,
                globalTimer: null,
                questionStates: {}, 
                penaltyActiveKey: null
            },

            init() {
                db.forEach(test => {
                    test.questions.forEach(q => {
                        this.state.questionStates[`${test.id}-${q.id}`] = { status: 'unanswered', attempts: 0, points: 0, selected: null };
                    });
                });
            },

            startExam() {
                const nameInput = document.getElementById('user-name-input').value.trim();
                if (!nameInput) {
                    alert("Please enter your name to start.");
                    return;
                }
                this.state.userName = nameInput;
                this.state.startTime = new Date();
                
                document.getElementById('header-name').textContent = this.state.userName;
                document.getElementById('screen-welcome').classList.add('hidden');
                document.getElementById('screen-app').classList.remove('hidden');
                document.getElementById('screen-app').classList.add('flex');

                this.startGlobalTimer();
                this.renderTest();
            },

            startGlobalTimer() {
                this.state.globalTimer = setInterval(() => {
                    const now = new Date();
                    const diff = now - this.state.startTime;
                    const date = new Date(diff);
                    const str = date.toISOString().substr(11, 8);
                    document.getElementById('timer-display').textContent = str;
                }, 1000);
            },

            renderTest() {
                const test = db[this.state.currentTestIdx];
                
                document.getElementById('header-title').textContent = `${test.id.toUpperCase()}: ${test.title}`;
                document.getElementById('header-progress').textContent = `${this.state.currentTestIdx + 1}/${db.length}`;
                
                this.renderText(test);
                this.renderQuestions(test);

                const btnNext = document.getElementById('btn-next');
                if (this.state.currentTestIdx === db.length - 1) {
                    btnNext.innerHTML = `<i class="fas fa-flag-checkered text-rose-600"></i>`;
                    btnNext.onclick = () => this.finishExam();
                } else {
                    btnNext.innerHTML = `<i class="fas fa-chevron-right"></i>`;
                    btnNext.onclick = () => this.navTest(1);
                }
                document.getElementById('btn-prev').disabled = this.state.currentTestIdx === 0;
            },

            renderText(test) {
                const contentDiv = document.getElementById('reading-text');
                contentDiv.innerHTML = test.text;

                test.questions.forEach(q => {
                    const key = `${test.id}-${q.id}`;
                    const state = this.state.questionStates[key];
                    const gapEl = document.getElementById(`gap-${key}`);
                    
                    if (gapEl) {
                        if (state.status === 'correct') {
                            gapEl.className = 'gap-slot filled-correct';
                            gapEl.textContent = q.options[q.correct];
                        } else if (state.status === 'wrong_final') {
                            gapEl.className = 'gap-slot filled-wrong';
                            gapEl.textContent = q.options[q.correct];
                        } else {
                            gapEl.className = 'gap-slot';
                        }
                    }
                });
            },

            renderQuestions(test) {
                const container = document.getElementById('questions-container');
                container.innerHTML = '';

                test.questions.forEach((q, idx) => {
                    const key = `${test.id}-${q.id}`;
                    const state = this.state.questionStates[key];
                    
                    const card = document.createElement('div');
                    card.id = `card-${key}`;
                    
                    // --- STYLE ---
                    let cardClasses = "relative rounded-xl border-2 p-5 transition-all duration-300 ";

                    // LOCKED
                    if (this.state.penaltyActiveKey && this.state.penaltyActiveKey !== key) {
                        cardClasses += "bg-white border-slate-100 opacity-50";
                        card.className = cardClasses;
                        card.innerHTML = `
                            <div class="absolute inset-0 z-20 backdrop-blur-[2px] bg-white/40 flex items-center justify-center rounded-xl">
                                <div class="bg-white px-4 py-2 rounded-full shadow-lg border border-slate-200 text-sm font-bold text-slate-500 flex items-center gap-2">
                                    <i class="fas fa-lock"></i> Finish current question...
                                </div>
                            </div>
                            <div class="flex justify-between mb-4 opacity-50"><span class="font-bold text-slate-300">${q.id}</span></div>
                            <div class="space-y-2 opacity-50">
                                <div class="h-10 bg-slate-50 rounded border border-slate-100"></div>
                            </div>
                        `;
                        container.appendChild(card);
                        return;
                    }

                    // ACTIVE PENALTY
                    if (state.status === 'penalty') {
                        cardClasses += "bg-[#fffbf0] border-orange-300 shadow-md overflow-hidden";
                        const progressBar = document.createElement('div');
                        progressBar.className = "absolute top-0 left-0 h-1.5 bg-orange-500 transition-all duration-100 ease-linear z-10";
                        progressBar.style.width = "100%";
                        progressBar.id = `timer-bar-${key}`;
                        card.appendChild(progressBar);
                    } 
                    else if (state.status === 'correct') {
                        cardClasses += "bg-green-50 border-green-200";
                    } 
                    else if (state.status === 'wrong_final') {
                        cardClasses += "bg-red-50 border-red-200";
                    } 
                    else {
                        cardClasses += "bg-white border-transparent shadow-sm hover:shadow-md";
                    }
                    
                    card.className = cardClasses;

                    // --- HEADER ---
                    const header = document.createElement('div');
                    header.className = "flex justify-between items-center mb-4 mt-2";
                    header.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full bg-slate-800 text-white font-bold flex items-center justify-center text-sm shadow-md">${q.id}</span>
                            <span class="text-xs text-slate-400 font-bold uppercase tracking-wide">Select Answer</span>
                        </div>
                    `;
                    
                    if (state.status === 'correct') header.innerHTML += `<span class="text-green-600 font-bold text-sm bg-white px-2 py-1 rounded shadow-sm"><i class="fas fa-check"></i> Correct!</span>`;
                    if (state.status === 'wrong_final') header.innerHTML += `<span class="text-red-600 font-bold text-sm bg-white px-2 py-1 rounded shadow-sm"><i class="fas fa-times"></i> Failed</span>`;
                    if (state.status === 'penalty') {
                        header.innerHTML += `<span class="text-orange-600 font-bold text-sm flex items-center gap-2"><i class="fas fa-circle-notch fa-spin"></i> Think again...</span>`;
                    }
                    
                    card.appendChild(header);

                    // --- OPTIONS ---
                    const grid = document.createElement('div');
                    grid.className = "grid grid-cols-1 sm:grid-cols-2 gap-3 mb-2";

                    for (const [optKey, optVal] of Object.entries(q.options)) {
                        const btn = document.createElement('button');
                        btn.className = `group relative w-full text-left px-4 py-3 rounded-xl border text-sm font-bold transition-all duration-200 flex items-center gap-3 `;
                        
                        if (state.status === 'unanswered') {
                            btn.className += "bg-white border-slate-200 text-slate-600 hover:border-rose-400 hover:bg-rose-50 hover:text-rose-700 shadow-sm";
                            btn.onclick = () => this.handleAnswer(test.id, q.id, optKey);
                        } 
                        else if (state.status === 'penalty') {
                            btn.disabled = true;
                            if (optKey === state.selected) {
                                btn.className += "bg-red-50 border-red-100 text-red-400 opacity-100 cursor-not-allowed";
                                btn.innerHTML += `<i class="fas fa-times absolute right-3 text-red-400"></i>`;
                            } else {
                                btn.className += "bg-white border-slate-100 text-slate-300 opacity-60 cursor-not-allowed";
                            }
                        }
                        else if (state.status === 'correct') {
                            btn.disabled = true;
                            if (optKey === q.correct) {
                                btn.className += "bg-green-600 border-green-600 text-white shadow-md transform scale-[1.02]";
                                btn.innerHTML += `<i class="fas fa-check absolute right-3 text-white"></i>`;
                            } else {
                                btn.className += "bg-white border-slate-100 text-slate-300 opacity-50";
                            }
                        }
                        else if (state.status === 'wrong_final') {
                            btn.disabled = true;
                            if (optKey === q.correct) {
                                btn.className += "bg-green-100 border-green-300 text-green-700"; 
                                btn.innerHTML += `<i class="fas fa-check absolute right-3 text-green-500"></i>`;
                            } else if (optKey === state.selected) {
                                btn.className += "bg-red-500 border-red-600 text-white"; 
                            } else {
                                btn.className += "bg-white border-slate-100 text-slate-300 opacity-50";
                            }
                        }

                        // Label
                        if(!btn.innerHTML.includes('<span class="w-6')) { 
                             let labelClass = "w-6 h-6 rounded flex items-center justify-center text-xs font-bold ";
                             if (state.status === 'penalty' && optKey !== state.selected) {
                                 labelClass += "bg-slate-100 text-slate-300"; 
                             } else if (state.status === 'penalty' && optKey === state.selected) {
                                 labelClass += "bg-red-100 text-red-400"; 
                             } else {
                                 labelClass += "bg-slate-100 text-slate-500 group-hover:bg-rose-200 group-hover:text-rose-700";
                             }
                             btn.innerHTML = `<span class="${labelClass}">${optKey}</span> ${optVal}`;
                        }
                        grid.appendChild(btn);
                    }
                    card.appendChild(grid);

                    // --- EXPLANATION BOX (Correct/Fail) ---
                    if (state.status === 'correct' || state.status === 'wrong_final') {
                        const exp = document.createElement('div');
                        exp.className = `mt-4 rounded-xl border overflow-hidden ${state.status === 'correct' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`;
                        
                        // Header for explanation
                        const expHeader = document.createElement('div');
                        expHeader.className = `px-4 py-2 font-bold text-xs uppercase tracking-wider flex items-center gap-2 ${state.status === 'correct' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
                        expHeader.innerHTML = state.status === 'correct' ? '<i class="fas fa-lightbulb"></i> Detailed Explanation' : '<i class="fas fa-exclamation-circle"></i> Correction';
                        
                        const expContent = document.createElement('div');
                        expContent.className = "p-4 text-sm leading-relaxed text-slate-700";
                        expContent.innerHTML = q.explanation; // Inject HTML formatted string

                        exp.appendChild(expHeader);
                        exp.appendChild(expContent);
                        card.appendChild(exp);
                    }

                    container.appendChild(card);
                });
            },

            handleAnswer(testId, qId, selectedOpt) {
                if (this.state.penaltyActiveKey) return; 

                const test = db[this.state.currentTestIdx];
                const q = test.questions.find(item => item.id === qId);
                const key = `${testId}-${qId}`;
                const state = this.state.questionStates[key];

                state.selected = selectedOpt; 

                if (selectedOpt === q.correct) {
                    playSound('correct');
                    state.status = 'correct';
                    state.points = state.attempts === 0 ? 1 : 0.5;
                    this.state.score += state.points;
                } else {
                    playSound('wrong');
                    state.attempts++;
                    if (state.attempts === 1) {
                        state.status = 'penalty';
                        this.state.penaltyActiveKey = key; 
                        this.startPenaltyTimer(key);
                    } else {
                        state.status = 'wrong_final';
                        state.points = 0;
                    }
                }

                this.renderTest(); 
            },

            startPenaltyTimer(key) {
                let timeLeft = 100; // 10s
                const interval = setInterval(() => {
                    timeLeft--;
                    const bar = document.getElementById(`timer-bar-${key}`);
                    if (bar) bar.style.width = `${timeLeft}%`;

                    if (timeLeft <= 0) {
                        clearInterval(interval);
                        const state = this.state.questionStates[key];
                        state.status = 'unanswered'; 
                        state.selected = null; 
                        this.state.penaltyActiveKey = null; 
                        this.renderTest();
                    }
                }, 100); 
            },

            navTest(direction) {
                if (this.state.penaltyActiveKey) return; 
                this.state.currentTestIdx += direction;
                
                document.getElementById('reading-text').parentElement.scrollTop = 0;
                document.getElementById('questions-container').scrollTop = 0;
                
                this.renderTest();
            },

            finishExam() {
                clearInterval(this.state.globalTimer);
                this.state.endTime = new Date();

                const totalQ = 24; // 6 questions * 4 tests
                const score = this.state.score;
                const percent = Math.round((score / totalQ) * 100);
                const diffMs = this.state.endTime - this.state.startTime;
                
                const minutes = Math.floor(diffMs / 60000);
                const seconds = Math.floor(((diffMs % 60000) / 1000));
                const durationStr = `${minutes} min ${seconds} sec`;

                document.getElementById('screen-app').classList.add('hidden');
                document.getElementById('screen-result').classList.remove('hidden');

                document.getElementById('result-candidate').textContent = this.state.userName;
                document.getElementById('result-score').textContent = score;
                document.getElementById('result-percent').textContent = `${percent}%`;
                document.getElementById('result-duration').textContent = durationStr;

                // Status Message
                const statusMsg = document.getElementById('result-status-msg');
                if (percent >= 85) {
                    statusMsg.innerHTML = `<i class="fas fa-check-circle text-green-500"></i> <span class="text-green-600">Passed! You have mastered this set.</span>`;
                } else {
                    statusMsg.innerHTML = `<i class="fas fa-exclamation-triangle text-orange-500"></i> <span class="text-orange-600">Not Passed. You need 85% to master this set.</span>`;
                }

                // Render List
                const listContainer = document.getElementById('result-list');
                listContainer.innerHTML = '';

                // Calculate score per test
                db.forEach((test, idx) => {
                    let correctCount = 0;
                    test.questions.forEach(q => {
                        const s = this.state.questionStates[`${test.id}-${q.id}`];
                        if (s.status === 'correct') correctCount++; // Simplified counting
                    });

                    const item = document.createElement('div');
                    item.className = "bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm";
                    item.innerHTML = `
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">TEST ${idx + 1}</p>
                            <h4 class="font-bold text-slate-800">${test.title}</h4>
                        </div>
                        <span class="font-bold text-slate-600 text-lg">${correctCount}/6 correct</span>
                    `;
                    listContainer.appendChild(item);
                });
            }
        };

        app.init();

    </script>
</body>
</html>