<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PET Reading Part 5 - Set 2 (Mastery Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Font: Plus Jakarta Sans */
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Gap Styles inside Text */
        .gap-slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 24px;
            padding: 0 6px;
            margin: 0 2px;
            border-radius: 4px;
            background-color: #f1f5f9;
            color: #64748b;
            font-weight: 700;
            font-size: 0.9em;
            border: 1px solid #e2e8f0;
            cursor: default;
            transition: all 0.2s;
        }
        .gap-slot.filled-correct { background-color: #dcfce7; color: #15803d; border-color: #86efac; }
        .gap-slot.filled-wrong { background-color: #fee2e2; color: #b91c1c; border-color: #fca5a5; }
        .gap-slot.example { background-color: #dcfce7; color: #15803d; border-color: #86efac; font-weight: 800; }

        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        
        .progress-bar-transition { transition: width 0.1s linear; }

        /* FIX SCROLL JUMPING */
        #questions-container {
            overflow-anchor: none !important; /* Quan trọng: Tắt tính năng tự cuộn của trình duyệt */
        }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col text-slate-800 overflow-hidden">

    <!-- SCREEN 1: WELCOME (ROSE THEME) -->
    <div id="screen-welcome" class="fixed inset-0 z-50 bg-slate-50 flex items-center justify-center p-4">
        <div class="bg-white max-w-md w-full rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
            <div class="h-2 bg-rose-500 w-full"></div>
            <div class="p-8 text-center">
                <h1 class="text-3xl font-extrabold text-slate-800 mb-2">PET Reading Part 5</h1>
                <p class="text-slate-500 mb-6 font-medium">SET 2 (Tests 5 - 8)</p>
                
                <div class="inline-block bg-orange-100 text-orange-700 px-4 py-1 rounded-full text-xs font-bold tracking-wider mb-8">
                    MASTERY STUDY MODE
                </div>

                <div class="text-left mb-6">
                    <label class="block text-sm font-bold text-slate-700 mb-2 ml-1">Your Name</label>
                    <input type="text" id="user-name-input" placeholder="Enter your name..." 
                        class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-rose-500 focus:border-rose-500 outline-none transition-all text-slate-800 font-medium"
                        onkeypress="if(event.key === 'Enter') app.startExam()">
                </div>

                <button onclick="app.startExam()" class="w-full bg-rose-600 hover:bg-rose-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-rose-200 transition-transform active:scale-[0.98]">
                    Start Practice
                </button>
            </div>
            
            <div class="bg-slate-50 p-6 border-t border-slate-100">
                <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase flex items-center gap-2">
                    <i class="fas fa-info-circle text-slate-400"></i> Mastery Rules
                </h3>
                <ul class="space-y-3 text-sm font-medium">
                    <li class="flex items-start gap-3">
                        <i class="fas fa-check text-green-500 mt-0.5"></i>
                        <span class="text-slate-600"><strong class="text-green-700">1st Try Correct:</strong> Full points (100%).</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i class="fas fa-exclamation-triangle text-orange-500 mt-0.5"></i>
                        <span class="text-slate-600"><strong class="text-orange-600">1st Try Wrong:</strong> 10s Penalty Wait + Global Lock. Score reduced to 50%.</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i class="fas fa-times text-red-500 mt-0.5"></i>
                        <span class="text-slate-600"><strong class="text-red-600">2nd Try Wrong:</strong> 0 points. Answer revealed.</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i class="fas fa-star text-rose-500 mt-0.5"></i>
                        <span class="text-slate-600"><strong class="text-rose-700">Target:</strong> You need 85% score to pass.</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- SCREEN 2: MAIN APP -->
    <div id="screen-app" class="hidden flex-col h-full">
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 h-16 flex-none z-20">
            <div class="h-full max-w-[1920px] mx-auto px-6 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="px-3 py-1 bg-rose-50 border border-rose-200 rounded-lg text-rose-700 font-mono font-bold text-sm flex items-center gap-2">
                        <i class="far fa-clock"></i> <span id="timer-display">00:00:00</span>
                    </div>
                    <h2 id="header-title" class="font-bold text-slate-800 text-lg truncate">Test 5</h2>
                </div>

                <div class="flex items-center gap-6">
                     <div class="text-right hidden md:block">
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Candidate</p>
                        <p id="header-name" class="font-bold text-slate-700 text-sm">Student</p>
                    </div>
                    <div class="h-8 w-px bg-slate-200 hidden md:block"></div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mr-1">Progress</span>
                        <span id="header-progress" class="font-bold text-xl text-slate-800">1/4</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="app.navTest(-1)" id="btn-prev" class="w-9 h-9 rounded-full border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-50 hover:text-rose-600 disabled:opacity-30 transition-colors">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button onclick="app.navTest(1)" id="btn-next" class="w-9 h-9 rounded-full border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-50 hover:text-rose-600 transition-colors">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex overflow-hidden bg-slate-100">
            <div class="max-w-[1600px] w-full mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
                
                <!-- LEFT: TEXT -->
                <div class="lg:col-span-6 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
                    <div class="p-8 overflow-y-auto custom-scrollbar flex-grow">
                        <div id="reading-text" class="text-lg leading-8 text-slate-700 text-justify font-normal">
                            <!-- Text injected here -->
                        </div>
                    </div>
                </div>

                <!-- RIGHT: QUESTIONS -->
                <div class="lg:col-span-6 flex flex-col h-full overflow-hidden">
                    <div class="bg-white rounded-t-2xl border-b border-slate-100 p-4 flex justify-between items-center bg-white shadow-sm z-10">
                        <h3 class="font-bold text-rose-600 flex items-center gap-2">
                            <i class="far fa-file-alt"></i> QUESTIONS
                        </h3>
                        <span class="text-[10px] font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded border border-orange-100 tracking-wider">STUDY MODE</span>
                    </div>
                    
                    <div id="questions-container" class="flex-grow overflow-y-auto custom-scrollbar bg-slate-50/50 p-4 space-y-4">
                        <!-- Questions injected here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SCREEN 3: RESULT -->
    <div id="screen-result" class="hidden fixed inset-0 z-50 bg-slate-50 overflow-y-auto custom-scrollbar">
        <div class="min-h-screen w-full flex items-start justify-center p-6 md:py-12">
            <div class="max-w-3xl w-full flex flex-col gap-6">
                
                <!-- Title -->
                <div class="text-center mb-2">
                    <h1 class="text-4xl font-extrabold text-slate-800">Study Mode Results</h1>
                    <div id="result-status-msg" class="flex items-center justify-center gap-2 mt-3 font-bold text-lg"></div>
                </div>

                <!-- Top Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-rose-50/50 border border-rose-100 rounded-2xl p-6 flex flex-col justify-between h-32 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-rose-500"></div>
                        <p class="text-xs font-bold text-rose-500 uppercase tracking-wider">Candidate</p>
                        <p id="result-candidate" class="text-2xl font-bold text-slate-800 truncate">Student</p>
                    </div>

                    <div class="bg-red-50/50 border border-red-100 rounded-2xl p-6 flex flex-col justify-center h-32 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-red-400"></div>
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-xs font-bold text-red-500 uppercase tracking-wider mb-1">Mastery Score</p>
                                <div class="flex items-baseline gap-1">
                                    <span id="result-score" class="text-4xl font-extrabold text-slate-800">0</span>
                                    <span class="text-slate-400 font-medium text-lg">/ 24</span>
                                </div>
                            </div>
                            <div class="bg-white px-3 py-1 rounded-lg border border-red-100 shadow-sm">
                                <span id="result-percent" class="text-lg font-extrabold text-red-600">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Retry Button Rose/Red -->
                <button onclick="location.reload()" class="w-full bg-rose-600 hover:bg-rose-700 text-white text-lg font-bold py-4 rounded-xl shadow-lg shadow-rose-200 transition-all active:scale-[0.99] flex items-center justify-center gap-2">
                    <i class="fas fa-redo-alt"></i> Retry This Set
                </button>

                <!-- Stats Container -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-2">
                        <i class="far fa-clock text-slate-400"></i>
                        <h3 class="font-bold text-slate-700 text-sm">Performance Stats</h3>
                    </div>
                    <div class="p-6 flex justify-between items-center">
                        <span class="text-slate-500 font-medium">Duration:</span>
                        <span id="result-duration" class="font-bold text-slate-800">00 min 00 sec</span>
                    </div>
                </div>

                <!-- Detailed Breakdown -->
                <div id="result-list" class="space-y-3"></div>

            </div>
        </div>
    </div>

    <script>
        // --- Sound Effects System ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration, vol = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }
        function playSound(type) {
            if (type === 'correct') { playTone(600, 'sine', 0.1); setTimeout(() => playTone(900, 'sine', 0.15), 100); }
            else if (type === 'wrong') { playTone(200, 'sawtooth', 0.2, 0.2); }
        }

        // --- Explanation Template ---
        const formatExplanation = (correct, whyCorrect, whyWrong, note) => {
            return `
                <div class="space-y-3">
                    <div class="flex gap-2 text-sm">
                        <span class="font-bold text-green-700 shrink-0">Đáp án đúng:</span>
                        <span class="text-slate-700">${correct} - ${whyCorrect}</span>
                    </div>
                    <div class="text-sm">
                        <span class="font-bold text-red-600 block mb-1">Tại sao các đáp án khác sai:</span>
                        <ul class="list-disc pl-5 text-slate-600 space-y-1">${whyWrong}</ul>
                    </div>
                    ${note ? `<div class="text-sm bg-blue-50 p-2 rounded border border-blue-100 text-slate-700"><span class="font-bold text-blue-700">Ghi nhớ:</span> ${note}</div>` : ''}
                </div>
            `;
        };

        // --- DATA SET 2 (TESTS 5-8) ---
        const db = [
            {
                id: "test5",
                title: "An Interesting School Project",
                text: "<p class='mb-4 text-slate-500 italic text-sm border-l-4 border-rose-400 pl-3 py-1 bg-rose-50'><strong>Example:</strong> The best way to travel is by <span class='gap-slot example'>(0) PLANE</span>.</p>This month we're doing a project on unusual animals and my team got the Japanese Macaques, or as they are often called, snow monkeys. It was exciting to <span id='gap-test5-21' class='gap-slot'>(21)............</span> out so much about them.<br><br>These monkeys live at much lower temperatures than any other monkeys, feeding on a few plants while trying hard to stay warm. But what makes them so strange is their <span id='gap-test5-22' class='gap-slot'>(22)............</span> to pass on new ideas to each other, something <span id='gap-test5-23' class='gap-slot'>(23)............</span> in a scientific study when a single snow monkey started washing her food in the ocean. Following this, after a few generations, every monkey was doing it.<br><br>People who are <span id='gap-test5-24' class='gap-slot'>(24)............</span> in the Macaques often visit the Jigokudani Monkey Park in Jigokudani Valley, Japan. There the Macaques often have hot baths on a snowy winter's day. Well, this is not part of their typical <span id='gap-test5-25' class='gap-slot'>(25)............</span>. They have once again copied a single snow monkey who decided to jump into the hot spring water back in 1963 on a(n) <span id='gap-test5-26' class='gap-slot'>(26)............</span> cold day.",
                questions: [
                    { 
                        id: 21, options: { A: "carry", B: "find", C: "check", D: "hand" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. find", 
                            "Cụm động từ 'find out' có nghĩa là tìm hiểu/khám phá thông tin.",
                            "<li><b>A. carry:</b> đi với 'out' (carry out) nghĩa là thực hiện.</li><li><b>C. check:</b> đi với 'out' (check out) nghĩa là kiểm tra/trả phòng.</li><li><b>D. hand:</b> đi với 'out' (hand out) nghĩa là phân phát.</li>",
                            "Phrasal Verb: <i>Find out (about something)</i>."
                        )
                    },
                    { 
                        id: 22, options: { A: "possibility", B: "qualification", C: "ability", D: "lesson" }, correct: "C", 
                        explanation: formatExplanation(
                            "C. ability", 
                            "Khả năng làm gì đó (ability to do something). Ở đây là khả năng truyền đạt ý tưởng.",
                            "<li><b>A. possibility:</b> khả năng (xảy ra sự việc).</li><li><b>B. qualification:</b> bằng cấp/trình độ.</li><li><b>D. lesson:</b> bài học.</li>",
                            "Collocation: <i>Ability to pass on ideas</i>."
                        )
                    },
                    { 
                        id: 23, options: { A: "discovered", B: "invented", C: "designed", D: "located" }, correct: "A", 
                        explanation: formatExplanation(
                            "A. discovered", 
                            "Một điều được 'khám phá/phát hiện' (discovered) trong một nghiên cứu khoa học.",
                            "<li><b>B. invented:</b> phát minh (tạo ra cái mới).</li><li><b>C. designed:</b> thiết kế.</li><li><b>D. located:</b> xác định vị trí.</li>",
                            ""
                        )
                    },
                    { 
                        id: 24, options: { A: "amazed", B: "interested", C: "curious", D: "excited" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. interested", 
                            "Cấu trúc 'Interested in' (Quan tâm đến cái gì).",
                            "<li><b>A. amazed:</b> đi với 'at/by' (ngạc nhiên).</li><li><b>C. curious:</b> đi với 'about' (tò mò).</li><li><b>D. excited:</b> đi với 'about' (hào hứng).</li>",
                            "Grammar: <i>To be interested in something</i>."
                        )
                    },
                    { 
                        id: 25, options: { A: "behaviour", B: "portrait", C: "act", D: "role" }, correct: "A", 
                        explanation: formatExplanation(
                            "A. behaviour", 
                            "Hành vi điển hình (typical behaviour). Việc tắm nước nóng không phải hành vi tự nhiên.",
                            "<li><b>B. portrait:</b> chân dung.</li><li><b>C. act:</b> hành động (cụ thể).</li><li><b>D. role:</b> vai trò.</li>",
                            "Collocation: <i>Typical behaviour</i>."
                        )
                    },
                    { 
                        id: 26, options: { A: "frozen", B: "extreme", C: "spring", D: "freezing" }, correct: "D", 
                        explanation: formatExplanation(
                            "D. freezing", 
                            "Cụm từ 'freezing cold' dùng để nhấn mạnh trời rất lạnh (lạnh cóng).",
                            "<li><b>A. frozen:</b> bị đông cứng (dùng cho vật/nước).</li><li><b>B. extreme:</b> cực đoan.</li><li><b>C. spring:</b> mùa xuân.</li>",
                            "Collocation: <i>Freezing cold day</i>."
                        )
                    }
                ]
            },
            {
                id: "test6",
                title: "Choosing Your First Job",
                text: "<p class='mb-4 text-slate-500 italic text-sm border-l-4 border-rose-400 pl-3 py-1 bg-rose-50'><strong>Example:</strong> The best way to travel is by <span class='gap-slot example'>(0) PLANE</span>.</p>In general we will all spend about two thirds of our life at work. This means that we will probably have many different jobs over the years. However, our first <span id='gap-test6-21' class='gap-slot'>(21)............</span> of work is a very important one. If our first job is <span id='gap-test6-22' class='gap-slot'>(22)............</span>, we won't be worried about working. But if we have a job that makes us feel anxious or miserable, we may think that work is something to dislike forever.<br><br>For this reason a person should think carefully before they <span id='gap-test6-23' class='gap-slot'>(23)............</span> for their first job. For example, if you are the type of person that enjoys working outside and being very active, it would be silly to choose a(n) <span id='gap-test6-24' class='gap-slot'>(24)............</span> such as a receptionist. And let's face it, many people who start their first job are still teenagers with lots of energy. It's also important to have a job where you like your <span id='gap-test6-25' class='gap-slot'>(25)............</span>. There is nothing worse than having a boss that you don't like. But of course, you need to work hard and show that you are <span id='gap-test6-26' class='gap-slot'>(26)............</span> in order for them to trust you and know that you will do your job well.",
                questions: [
                    { 
                        id: 21, options: { A: "arrangement", B: "booking", C: "experience", D: "conference" }, correct: "C", 
                        explanation: formatExplanation(
                            "C. experience", 
                            "Trải nghiệm đầu tiên về công việc (first experience of work).",
                            "<li><b>A. arrangement:</b> sự sắp xếp.</li><li><b>B. booking:</b> đặt chỗ.</li><li><b>D. conference:</b> hội nghị.</li>",
                            ""
                        )
                    },
                    { 
                        id: 22, options: { A: "pleasant", B: "confusing", C: "satisfied", D: "rough" }, correct: "A", 
                        explanation: formatExplanation(
                            "A. pleasant", 
                            "Công việc dễ chịu/thoải mái (pleasant) thì sẽ không lo lắng. Ngược nghĩa với 'anxious/miserable' ở câu sau.",
                            "<li><b>B. confusing:</b> gây bối rối.</li><li><b>C. satisfied:</b> hài lòng (dùng cho người, VD: I am satisfied).</li><li><b>D. rough:</b> thô ráp/khó khăn.</li>",
                            ""
                        )
                    },
                    { 
                        id: 23, options: { A: "earn", B: "quit", C: "retire", D: "apply" }, correct: "D", 
                        explanation: formatExplanation(
                            "D. apply", 
                            "Cụm 'Apply for a job' (Nộp đơn xin việc).",
                            "<li><b>A. earn:</b> kiếm tiền.</li><li><b>B. quit:</b> bỏ việc.</li><li><b>C. retire:</b> nghỉ hưu.</li>",
                            "Collocation: <i>Apply for</i>."
                        )
                    },
                    { 
                        id: 24, options: { A: "occupation", B: "application", C: "contract", D: "qualification" }, correct: "A", 
                        explanation: formatExplanation(
                            "A. occupation", 
                            "Nghề nghiệp/công việc (occupation). Receptionist là một nghề.",
                            "<li><b>B. application:</b> đơn xin việc.</li><li><b>C. contract:</b> hợp đồng.</li><li><b>D. qualification:</b> bằng cấp.</li>",
                            ""
                        )
                    },
                    { 
                        id: 25, options: { A: "assistant", B: "employer", C: "servant", D: "employee" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. employer", 
                            "Người chủ/người thuê lao động. Câu sau giải thích 'There is nothing worse than having a BOSS...'. Boss = Employer.",
                            "<li><b>A. assistant:</b> trợ lý.</li><li><b>C. servant:</b> người hầu.</li><li><b>D. employee:</b> nhân viên.</li>",
                            "Vocabulary: <i>Employer (chủ) vs Employee (nhân viên)</i>."
                        )
                    },
                    { 
                        id: 26, options: { A: "bossy", B: "reliable", C: "typical", D: "gentle" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. reliable", 
                            "Đáng tin cậy (reliable). Cần thể hiện mình đáng tin để họ 'trust you'.",
                            "<li><b>A. bossy:</b> hống hách.</li><li><b>C. typical:</b> điển hình.</li><li><b>D. gentle:</b> nhẹ nhàng.</li>",
                            ""
                        )
                    }
                ]
            },
            {
                id: "test7",
                title: "The History of Fireworks",
                text: "<p class='mb-4 text-slate-500 italic text-sm border-l-4 border-rose-400 pl-3 py-1 bg-rose-50'><strong>Example:</strong> The best way to travel is by <span class='gap-slot example'>(0) PLANE</span>.</p>Fireworks were discovered by chance around 2000 years ago, in China. They were made from three <span id='gap-test7-21' class='gap-slot'>(21)............</span> kitchen ingredients, which were heated over a fire to make a black powder. When lit, the powder created a bright light and made a very loud noise. Today, we <span id='gap-test7-22' class='gap-slot'>(22)............</span> this 'gunpowder'.<br><br>But it was many years later that the Italians <span id='gap-test7-23' class='gap-slot'>(23)............</span> the first real fireworks. Made from the same ingredients as gunpowder, these fireworks were <span id='gap-test7-24' class='gap-slot'>(24)............</span> for public displays. However, they were very basic, as the only colours available to make fireworks were yellow and orange.<br><br>Nowadays, firework displays are really spectacular. The UK is especially famous for its firework displays held all over the <span id='gap-test7-25' class='gap-slot'>(25)............</span> on November 5th. This day celebrates an important historical <span id='gap-test7-26' class='gap-slot'>(26)............</span> in the English calendar. It is known as Bonfire Night, or, Guy Fawkes Night. Other than setting off fireworks, the English light bonfires, and sometimes burn a doll that looks like a man who once wanted to kill their king but failed.",
                questions: [
                    { 
                        id: 21, options: { A: "unique", B: "common", C: "unnecessary", D: "original" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. common", 
                            "Nguyên liệu nhà bếp 'thông thường/phổ biến' (common). Ý nói dễ tìm thấy.",
                            "<li><b>A. unique:</b> độc đáo.</li><li><b>C. unnecessary:</b> không cần thiết.</li><li><b>D. original:</b> nguyên bản.</li>",
                            ""
                        )
                    },
                    { 
                        id: 22, options: { A: "name", B: "call", C: "say", D: "tell" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. call", 
                            "Cấu trúc 'Call something + name' (Gọi cái gì là...). 'We call this gunpowder'.",
                            "<li><b>A. name:</b> thường dùng 'name something after someone'.</li><li><b>C. say:</b> nói.</li><li><b>D. tell:</b> kể.</li>",
                            "Grammar: <i>Call [object] [name]</i>."
                        )
                    },
                    { 
                        id: 23, options: { A: "cooked", B: "improved", C: "created", D: "found" }, correct: "C", 
                        explanation: formatExplanation(
                            "C. created", 
                            "Người Ý đã 'tạo ra' (created) pháo hoa thực sự đầu tiên.",
                            "<li><b>A. cooked:</b> nấu.</li><li><b>B. improved:</b> cải thiện.</li><li><b>D. found:</b> tìm thấy.</li>",
                            ""
                        )
                    },
                    { 
                        id: 24, options: { A: "attempted", B: "installed", C: "hidden", D: "used" }, correct: "D", 
                        explanation: formatExplanation(
                            "D. used", 
                            "Pháo hoa được 'sử dụng' (used) cho các buổi trình diễn công cộng.",
                            "<li><b>A. attempted:</b> cố gắng.</li><li><b>B. installed:</b> cài đặt.</li><li><b>C. hidden:</b> giấu kín.</li>",
                            ""
                        )
                    },
                    { 
                        id: 25, options: { A: "location", B: "country", C: "month", D: "time" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. country", 
                            "Cụm từ 'All over the country' (Trên khắp cả nước). Ở đây chỉ Vương quốc Anh (UK).",
                            "<li><b>A. location:</b> địa điểm.</li><li><b>C. month:</b> tháng.</li><li><b>D. time:</b> thời gian.</li>",
                            "Collocation: <i>All over the country/world</i>."
                        )
                    },
                    { 
                        id: 26, options: { A: "event", B: "performance", C: "presentation", D: "show" }, correct: "A", 
                        explanation: formatExplanation(
                            "A. event", 
                            "Sự kiện lịch sử (historical event).",
                            "<li><b>B. performance:</b> buổi biểu diễn.</li><li><b>C. presentation:</b> bài thuyết trình.</li><li><b>D. show:</b> chương trình.</li>",
                            "Collocation: <i>Historical event</i>."
                        )
                    }
                ]
            },
            {
                id: "test8",
                title: "Edinburgh",
                text: "<p class='mb-4 text-slate-500 italic text-sm border-l-4 border-rose-400 pl-3 py-1 bg-rose-50'><strong>Example:</strong> The best way to travel is by <span class='gap-slot example'>(0) PLANE</span>.</p>Edinburgh, the capital of Scotland, is known as The Athens of the North. It may not have the great climate of Greece, but it has its <span id='gap-test8-21' class='gap-slot'>(21)............</span> in its architecture. The New Town, which started to be built in the 1760s, has many important buildings, <span id='gap-test8-22' class='gap-slot'>(22)............</span> by classical architecture.<br><br>Today, this area of Edinburgh is full of galleries, cafes, restaurants and shops and is very <span id='gap-test8-23' class='gap-slot'>(23)............</span> with the hundreds of thousands of tourists that visit the city all year round.<br><br>Probably the most famous building is Edinburgh Castle. Parts of the castle date back as far as the 11th century. Back then, the city was completely different to the busy tourist <span id='gap-test8-24' class='gap-slot'>(24)............</span> of today. It was a dark foggy city because of all the fires which were burning. Add to that the <span id='gap-test8-25' class='gap-slot'>(25)............</span> of waste from the human population, and it's not surprising that it was extremely smelly.<br><br>Luckily, today Edinburgh is known for better things. Probably one of the most important <span id='gap-test8-26' class='gap-slot'>(26)............</span> is the Fringe Festival which takes place every summer and fills the city with performers and tourists from all over the world.",
                questions: [
                    { 
                        id: 21, options: { A: "effect", B: "image", C: "influence", D: "result" }, correct: "C", 
                        explanation: formatExplanation(
                            "C. influence", 
                            "Ảnh hưởng (influence). Nó có sự ảnh hưởng của Hy Lạp trong kiến trúc (được gọi là Athens phương Bắc).",
                            "<li><b>A. effect:</b> tác động/hiệu ứng (thường đi với 'on').</li><li><b>B. image:</b> hình ảnh.</li><li><b>D. result:</b> kết quả.</li>",
                            ""
                        )
                    },
                    { 
                        id: 22, options: { A: "inspired", B: "educated", C: "built", D: "destroyed" }, correct: "A", 
                        explanation: formatExplanation(
                            "A. inspired", 
                            "Được lấy cảm hứng (inspired by) từ kiến trúc cổ điển.",
                            "<li><b>B. educated:</b> được giáo dục.</li><li><b>C. built:</b> được xây dựng (không đi với 'by classical architecture' theo nghĩa này).</li><li><b>D. destroyed:</b> bị phá hủy.</li>",
                            "Collocation: <i>Inspired by</i>."
                        )
                    },
                    { 
                        id: 23, options: { A: "positive", B: "popular", C: "famous", D: "accepted" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. popular", 
                            "Phổ biến/được yêu thích bởi (popular with) du khách.",
                            "<li><b>A. positive:</b> tích cực.</li><li><b>C. famous:</b> nổi tiếng (thường đi với 'for').</li><li><b>D. accepted:</b> được chấp nhận.</li>",
                            "Collocation: <i>Popular with someone</i>."
                        )
                    },
                    { 
                        id: 24, options: { A: "site", B: "sight", C: "building", D: "attraction" }, correct: "D", 
                        explanation: formatExplanation(
                            "D. attraction", 
                            "Địa điểm thu hút khách du lịch (tourist attraction).",
                            "<li><b>A. site:</b> địa điểm (xây dựng/khảo cổ).</li><li><b>B. sight:</b> cảnh đẹp/tầm nhìn.</li><li><b>C. building:</b> tòa nhà.</li>",
                            "Collocation: <i>Tourist attraction</i>."
                        )
                    },
                    { 
                        id: 25, options: { A: "total", B: "amount", C: "sum", D: "number" }, correct: "B", 
                        explanation: formatExplanation(
                            "B. amount", 
                            "'The amount of waste'. Waste (rác thải) là danh từ không đếm được nên dùng 'amount'.",
                            "<li><b>A. total:</b> tổng số.</li><li><b>C. sum:</b> tổng (tiền).</li><li><b>D. number:</b> số lượng (dùng cho danh từ đếm được).</li>",
                            "Grammar: <i>Amount of + Uncountable Noun</i>."
                        )
                    },
                    { 
                        id: 26, options: { A: "events", B: "facts", C: "activities", D: "actions" }, correct: "A", 
                        explanation: formatExplanation(
                            "A. events", 
                            "Sự kiện (events). Fringe Festival là một sự kiện quan trọng.",
                            "<li><b>B. facts:</b> sự thật.</li><li><b>C. activities:</b> hoạt động.</li><li><b>D. actions:</b> hành động.</li>",
                            ""
                        )
                    }
                ]
            }
        ];

        // --- Application Logic ---
        const app = {
            state: {
                currentTestIdx: 0,
                score: 0,
                userName: "Student",
                startTime: null,
                endTime: null,
                globalTimer: null,
                questionStates: {}, 
                penaltyActiveKey: null
            },

            init() {
                db.forEach(test => {
                    test.questions.forEach(q => {
                        this.state.questionStates[`${test.id}-${q.id}`] = { status: 'unanswered', attempts: 0, points: 0, selected: null };
                    });
                });
            },

            startExam() {
                const nameInput = document.getElementById('user-name-input').value.trim();
                if (!nameInput) {
                    alert("Please enter your name to start.");
                    return;
                }
                this.state.userName = nameInput;
                this.state.startTime = new Date();
                
                document.getElementById('header-name').textContent = this.state.userName;
                document.getElementById('screen-welcome').classList.add('hidden');
                document.getElementById('screen-app').classList.remove('hidden');
                document.getElementById('screen-app').classList.add('flex');

                this.startGlobalTimer();
                this.renderTest();
            },

            startGlobalTimer() {
                this.state.globalTimer = setInterval(() => {
                    const now = new Date();
                    const diff = now - this.state.startTime;
                    const date = new Date(diff);
                    const str = date.toISOString().substr(11, 8);
                    document.getElementById('timer-display').textContent = str;
                }, 1000);
            },

            renderTest(preserveScroll = false) {
                const test = db[this.state.currentTestIdx];
                
                // 1. Capture Scroll & Blur Focus
                const container = document.getElementById('questions-container');
                let scrollPos = 0;
                
                if (preserveScroll && container) {
                    scrollPos = container.scrollTop;
                    // Defocus to prevent browser auto-scroll behavior
                    if (document.activeElement && document.activeElement.tagName === 'BUTTON') {
                        document.activeElement.blur();
                    }
                }

                document.getElementById('header-title').textContent = `${test.id.toUpperCase()}: ${test.title}`;
                document.getElementById('header-progress').textContent = `${this.state.currentTestIdx + 1}/${db.length}`;
                
                this.renderText(test);
                this.renderQuestions(test);

                const btnNext = document.getElementById('btn-next');
                if (this.state.currentTestIdx === db.length - 1) {
                    btnNext.innerHTML = `<i class="fas fa-flag-checkered text-rose-600"></i>`;
                    btnNext.onclick = () => this.finishExam();
                } else {
                    btnNext.innerHTML = `<i class="fas fa-chevron-right"></i>`;
                    btnNext.onclick = () => this.navTest(1);
                }
                document.getElementById('btn-prev').disabled = this.state.currentTestIdx === 0;

                // 2. Restore Scroll with RequestAnimationFrame (Microtask)
                if (preserveScroll && container) {
                    requestAnimationFrame(() => {
                         container.scrollTop = scrollPos;
                    });
                }
            },

            renderText(test) {
                const contentDiv = document.getElementById('reading-text');
                contentDiv.innerHTML = test.text;

                test.questions.forEach(q => {
                    const key = `${test.id}-${q.id}`;
                    const state = this.state.questionStates[key];
                    const gapEl = document.getElementById(`gap-${key}`);
                    
                    if (gapEl) {
                        if (state.status === 'correct') {
                            gapEl.className = 'gap-slot filled-correct';
                            gapEl.textContent = q.options[q.correct];
                        } else if (state.status === 'wrong_final') {
                            gapEl.className = 'gap-slot filled-wrong';
                            gapEl.textContent = q.options[q.correct];
                        } else {
                            gapEl.className = 'gap-slot';
                        }
                    }
                });
            },

            renderQuestions(test) {
                const container = document.getElementById('questions-container');
                // Smart Render Logic
                
                // Check if we are updating current test or switching to new test
                const firstKey = `${test.id}-${test.questions[0].id}`;
                const firstCard = document.getElementById(`card-${firstKey}`);
                const isUpdate = !!firstCard;

                if (!isUpdate) {
                    container.innerHTML = '';
                }

                test.questions.forEach((q, idx) => {
                    const key = `${test.id}-${q.id}`;
                    const state = this.state.questionStates[key];
                    
                    // --- STYLE GENERATION ---
                    let cardClasses = "relative rounded-xl border-2 p-5 transition-all duration-300 ";
                    let cardContent = "";

                    // LOCKED STATE
                    if (this.state.penaltyActiveKey && this.state.penaltyActiveKey !== key) {
                        cardClasses += "bg-white border-slate-100 opacity-50";
                        cardContent = `
                            <div class="absolute inset-0 z-20 backdrop-blur-[2px] bg-white/40 flex items-center justify-center rounded-xl">
                                <div class="bg-white px-4 py-2 rounded-full shadow-lg border border-slate-200 text-sm font-bold text-slate-500 flex items-center gap-2">
                                    <i class="fas fa-lock"></i> Finish current question...
                                </div>
                            </div>
                            <div class="flex justify-between mb-4 opacity-50"><span class="font-bold text-slate-300">${q.id}</span></div>
                            <div class="space-y-2 opacity-50">
                                <div class="h-10 bg-slate-50 rounded border border-slate-100"></div>
                            </div>
                        `;
                    } else {
                        // NORMAL / PENALTY / CORRECT / WRONG STATE
                        if (state.status === 'penalty') {
                            cardClasses += "bg-[#fffbf0] border-orange-300 shadow-md overflow-hidden";
                        } else if (state.status === 'correct') {
                            cardClasses += "bg-green-50 border-green-200";
                        } else if (state.status === 'wrong_final') {
                            cardClasses += "bg-red-50 border-red-200";
                        } else {
                            cardClasses += "bg-white border-transparent shadow-sm hover:shadow-md";
                        }

                        // Build Content
                        
                        // 1. Progress Bar (Penalty only)
                        if (state.status === 'penalty') {
                            cardContent += `<div id="timer-bar-${key}" class="absolute top-0 left-0 h-1.5 bg-orange-500 transition-all duration-100 ease-linear z-10" style="width: 100%"></div>`;
                        }

                        // 2. Header
                        let headerStatus = "";
                        if (state.status === 'correct') headerStatus = `<span class="text-green-600 font-bold text-sm bg-white px-2 py-1 rounded shadow-sm"><i class="fas fa-check"></i> Correct!</span>`;
                        if (state.status === 'wrong_final') headerStatus = `<span class="text-red-600 font-bold text-sm bg-white px-2 py-1 rounded shadow-sm"><i class="fas fa-times"></i> Failed</span>`;
                        if (state.status === 'penalty') headerStatus = `<span class="text-orange-600 font-bold text-sm flex items-center gap-2"><i class="fas fa-circle-notch fa-spin"></i> Think again...</span>`;

                        cardContent += `
                            <div class="flex justify-between items-center mb-4 mt-2">
                                <div class="flex items-center gap-3">
                                    <span class="w-8 h-8 rounded-full bg-slate-800 text-white font-bold flex items-center justify-center text-sm shadow-md">${q.id}</span>
                                    <span class="text-xs text-slate-400 font-bold uppercase tracking-wide">Select Answer</span>
                                </div>
                                ${headerStatus}
                            </div>
                        `;

                        // 3. Options Grid
                        cardContent += `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-2">`;
                        for (const [optKey, optVal] of Object.entries(q.options)) {
                            let btnClass = `group relative w-full text-left px-4 py-3 rounded-xl border text-sm font-bold transition-all duration-200 flex items-center gap-3 `;
                            let labelClass = "w-6 h-6 rounded flex items-center justify-center text-xs font-bold ";
                            let iconHtml = "";
                            let isDisabled = "";
                            let clickHandler = `onclick="app.handleAnswer('${test.id}', ${q.id}, '${optKey}')"`;

                            if (state.status === 'unanswered') {
                                btnClass += "bg-white border-slate-200 text-slate-600 hover:border-rose-400 hover:bg-rose-50 hover:text-rose-700 shadow-sm";
                                labelClass += "bg-slate-100 text-slate-500 group-hover:bg-rose-200 group-hover:text-rose-700";
                            } 
                            else if (state.status === 'penalty') {
                                isDisabled = "disabled";
                                clickHandler = "";
                                if (optKey === state.selected) {
                                    btnClass += "bg-red-50 border-red-100 text-red-400 opacity-100 cursor-not-allowed";
                                    iconHtml = `<i class="fas fa-times absolute right-3 text-red-400"></i>`;
                                    labelClass += "bg-red-100 text-red-400";
                                } else {
                                    btnClass += "bg-white border-slate-100 text-slate-300 opacity-60 cursor-not-allowed";
                                    labelClass += "bg-slate-100 text-slate-300";
                                }
                            }
                            else if (state.status === 'correct') {
                                isDisabled = "disabled";
                                clickHandler = "";
                                if (optKey === q.correct) {
                                    btnClass += "bg-green-600 border-green-600 text-white shadow-md transform scale-[1.02]";
                                    iconHtml = `<i class="fas fa-check absolute right-3 text-white"></i>`;
                                    labelClass += "bg-white/20 text-white"; // Special label for correct
                                } else {
                                    btnClass += "bg-white border-slate-100 text-slate-300 opacity-50";
                                    labelClass += "bg-slate-100 text-slate-500";
                                }
                            }
                            else if (state.status === 'wrong_final') {
                                isDisabled = "disabled";
                                clickHandler = "";
                                if (optKey === q.correct) {
                                    btnClass += "bg-green-100 border-green-300 text-green-700"; 
                                    iconHtml = `<i class="fas fa-check absolute right-3 text-green-500"></i>`;
                                    labelClass += "bg-green-200 text-green-700";
                                } else if (optKey === state.selected) {
                                    btnClass += "bg-red-500 border-red-600 text-white"; 
                                    labelClass += "bg-white/20 text-white";
                                } else {
                                    btnClass += "bg-white border-slate-100 text-slate-300 opacity-50";
                                    labelClass += "bg-slate-100 text-slate-500";
                                }
                            }

                            cardContent += `
                                <button ${isDisabled} class="${btnClass}" ${clickHandler}>
                                    <span class="${labelClass}">${optKey}</span> 
                                    ${optVal}
                                    ${iconHtml}
                                </button>
                            `;
                        }
                        cardContent += `</div>`;

                        // 4. Explanation
                        if (state.status === 'correct' || state.status === 'wrong_final') {
                            const expClass = state.status === 'correct' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                            const headerClass = state.status === 'correct' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                            const headerText = state.status === 'correct' ? '<i class="fas fa-lightbulb"></i> Detailed Explanation' : '<i class="fas fa-exclamation-circle"></i> Correction';
                            
                            cardContent += `
                                <div class="mt-4 rounded-xl border overflow-hidden ${expClass}">
                                    <div class="px-4 py-2 font-bold text-xs uppercase tracking-wider flex items-center gap-2 ${headerClass}">
                                        ${headerText}
                                    </div>
                                    <div class="p-4 text-sm leading-relaxed text-slate-700">
                                        ${q.explanation}
                                    </div>
                                </div>
                            `;
                        }
                    }

                    // --- DOM MANIPULATION ---
                    let card;
                    if (isUpdate) {
                        card = document.getElementById(`card-${key}`);
                        // Only update if something changed (simple check) or just force update
                        if (card) {
                            card.className = cardClasses;
                            // Check if content changed to avoid recreating DOM if not needed (optional optimization)
                            // For simplicity and to ensure progress bars reset correctly, we replace innerHTML
                            // BUT for the progress bar animation to not flicker, we might want to check
                            // However, since we re-render on penalty start/end, swapping innerHTML is fine.
                            // The flickering comes from container height change, which we avoided by not clearing container.
                            card.innerHTML = cardContent;
                        }
                    } else {
                        card = document.createElement('div');
                        card.id = `card-${key}`;
                        card.className = cardClasses;
                        card.innerHTML = cardContent;
                        container.appendChild(card);
                    }
                });
            },

            handleAnswer(testId, qId, selectedOpt) {
                if (this.state.penaltyActiveKey) return; 

                const test = db[this.state.currentTestIdx];
                const q = test.questions.find(item => item.id === qId);
                const key = `${testId}-${qId}`;
                const state = this.state.questionStates[key];

                state.selected = selectedOpt; 

                if (selectedOpt === q.correct) {
                    playSound('correct');
                    state.status = 'correct';
                    state.points = state.attempts === 0 ? 1 : 0.5;
                    this.state.score += state.points;
                } else {
                    playSound('wrong');
                    state.attempts++;
                    if (state.attempts === 1) {
                        state.status = 'penalty';
                        this.state.penaltyActiveKey = key; 
                        this.startPenaltyTimer(key);
                    } else {
                        state.status = 'wrong_final';
                        state.points = 0;
                    }
                }

                this.renderTest(true); // Preserve scroll
            },

            startPenaltyTimer(key) {
                let timeLeft = 100; // 10s
                const interval = setInterval(() => {
                    timeLeft--;
                    const bar = document.getElementById(`timer-bar-${key}`);
                    if (bar) bar.style.width = `${timeLeft}%`;

                    if (timeLeft <= 0) {
                        clearInterval(interval);
                        const state = this.state.questionStates[key];
                        state.status = 'unanswered'; 
                        state.selected = null; 
                        this.state.penaltyActiveKey = null; 
                        this.renderTest(true); // Preserve scroll
                    }
                }, 100); 
            },

            navTest(direction) {
                if (this.state.penaltyActiveKey) return; 
                this.state.currentTestIdx += direction;
                
                // Explicitly reset scroll for new test
                const textContainer = document.getElementById('reading-text').parentElement;
                const qContainer = document.getElementById('questions-container');
                if (textContainer) textContainer.scrollTop = 0;
                if (qContainer) qContainer.scrollTop = 0;
                
                this.renderTest(false);
            },

            finishExam() {
                clearInterval(this.state.globalTimer);
                this.state.endTime = new Date();

                const totalQ = 24; // 6 questions * 4 tests
                const score = this.state.score;
                const percent = Math.round((score / totalQ) * 100);
                const diffMs = this.state.endTime - this.state.startTime;
                
                const minutes = Math.floor(diffMs / 60000);
                const seconds = Math.floor(((diffMs % 60000) / 1000));
                const durationStr = `${minutes} min ${seconds} sec`;

                document.getElementById('screen-app').classList.add('hidden');
                document.getElementById('screen-result').classList.remove('hidden');

                document.getElementById('result-candidate').textContent = this.state.userName;
                document.getElementById('result-score').textContent = score;
                document.getElementById('result-percent').textContent = `${percent}%`;
                document.getElementById('result-duration').textContent = durationStr;

                // Status Message
                const statusMsg = document.getElementById('result-status-msg');
                if (percent >= 85) {
                    statusMsg.innerHTML = `<i class="fas fa-check-circle text-green-500"></i> <span class="text-green-600">Passed! You have mastered this set.</span>`;
                } else {
                    statusMsg.innerHTML = `<i class="fas fa-exclamation-triangle text-orange-500"></i> <span class="text-orange-600">Not Passed. You need 85% to master this set.</span>`;
                }

                // Render List
                const listContainer = document.getElementById('result-list');
                listContainer.innerHTML = '';

                // Calculate score per test
                db.forEach((test, idx) => {
                    let correctCount = 0;
                    test.questions.forEach(q => {
                        const s = this.state.questionStates[`${test.id}-${q.id}`];
                        if (s.status === 'correct') correctCount++; // Simplified counting
                    });

                    const item = document.createElement('div');
                    item.className = "bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm";
                    item.innerHTML = `
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">TEST ${idx + 5}</p>
                            <h4 class="font-bold text-slate-800">${test.title}</h4>
                        </div>
                        <span class="font-bold text-slate-600 text-lg">${correctCount}/6 correct</span>
                    `;
                    listContainer.appendChild(item);
                });
            }
        };

        app.init();

    </script>
</body>
</html>